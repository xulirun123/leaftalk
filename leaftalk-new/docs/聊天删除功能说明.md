# 聊天删除功能说明

## 功能概述

叶语聊天应用提供了两种删除功能，都只影响当前用户的本地数据，不会影响其他用户的聊天记录。

## 功能详情

### 1. 清空聊天记录 🧹

**功能描述**：删除所有聊天消息，但保留会话

**影响范围**：
- ✅ 只清空您本地的聊天记录
- ✅ 不会影响对方的聊天记录
- ✅ 会话仍会保留，可以继续聊天
- ❌ 清空后无法恢复

**操作方式**：
1. 在聊天列表中长按聊天项
2. 选择"清空聊天记录"
3. 确认操作

**技术实现**：
- 从本地内存中清除消息
- 从本地IndexedDB中删除消息记录
- 标记会话为已清空，防止重新加载历史消息
- 不向服务器发送删除请求

### 2. 删除聊天 🗑️

**功能描述**：完全删除会话和所有聊天记录

**影响范围**：
- ✅ 只删除您本地的聊天记录和会话
- ✅ 不会影响对方的聊天记录
- ✅ 删除后需要重新创建会话才能聊天
- ❌ 删除后无法恢复

**操作方式**：
1. 在聊天列表中长按聊天项
2. 选择"删除聊天"
3. 确认操作

**技术实现**：
- 从本地内存中移除会话和消息
- 从本地IndexedDB中删除会话和消息记录
- 添加到删除列表，防止从服务器重新加载
- 不向服务器发送删除请求

## 数据保护机制

### 本地数据管理
- **内存清理**：立即从应用内存中移除相关数据
- **持久化清理**：从本地IndexedDB数据库中删除记录
- **缓存清理**：从localStorage缓存中移除相关数据

### 防重新加载机制
- **删除列表**：记录已删除的会话ID，防止从服务器重新加载
- **清空标记**：记录已清空的会话ID，防止加载历史消息
- **API同步控制**：在API同步时跳过已删除/清空的会话

### 服务器数据保护
- **不发送删除请求**：删除操作不会向服务器发送任何请求
- **保留服务器数据**：服务器上的聊天记录完全不受影响
- **其他用户不受影响**：其他用户的聊天记录和会话保持完整

## 使用场景

### 清空聊天记录适用于：
- 想要清理聊天界面但保持联系
- 释放本地存储空间
- 保护隐私但不影响对方

### 删除聊天适用于：
- 完全结束某个聊天关系
- 彻底清理不需要的会话
- 重新开始与某人的聊天

## 注意事项

1. **不可恢复**：删除操作无法撤销，请谨慎操作
2. **仅本地影响**：操作只影响您的设备，不影响其他用户
3. **重新聊天**：删除会话后，需要重新创建会话才能继续聊天
4. **数据同步**：删除后的数据不会在其他设备上同步删除

## 技术架构

### 数据存储层次
```
应用内存 (messages Map)
    ↓
本地缓存 (localStorage)
    ↓
持久化存储 (IndexedDB)
    ↓
服务器数据库 (不受影响)
```

### 删除流程
```
用户操作 → 确认对话框 → 本地数据清理 → 标记记录 → 缓存更新
```

### 防重新加载机制
```
启动应用 → 加载标记列表 → 过滤已删除/清空的会话 → 跳过API同步
```

## 开发者说明

### 相关文件
- `src/modules/chat/stores/chatStore.ts` - 核心删除逻辑
- `src/modules/chat/pages/ChatHomeEnterprise.vue` - 聊天列表删除操作
- `src/modules/chat/pages/ChatInfo.vue` - 聊天详情删除操作
- `src/modules/chat/services/messagePersistenceService.ts` - 持久化删除服务

### 关键函数
- `deleteChatItem()` - 删除聊天项
- `clearChatHistory()` - 清空聊天记录
- `loadMessagesForSession()` - 消息加载（带清空检查）
- `syncMessagesFromAPI()` - API同步（带清空检查）

### 存储键名
- `deleted_chat_sessions` - 已删除会话列表
- `cleared_chat_sessions` - 已清空会话列表
- `chat_sessions_cache` - 会话缓存
- `chat_messages_cache` - 消息缓存

这个设计确保了用户的隐私控制权，同时保护了其他用户的数据完整性。
