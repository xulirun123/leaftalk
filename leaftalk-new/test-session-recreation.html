<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会话重建功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #07C160;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            display: block;
            width: 100%;
            text-align: left;
        }
        .test-button:hover {
            background: #06A050;
        }
        .danger-button {
            background: #FF4444;
        }
        .danger-button:hover {
            background: #DD2222;
        }
        .log {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .step {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>🔄 会话重建功能测试</h1>
    
    <div class="test-section">
        <h2>📋 测试说明</h2>
        <div class="info status">
            <strong>测试目标：</strong><br>
            验证删除会话后，用户可以重新建立相同的会话
        </div>
        
        <div class="step">
            <strong>测试步骤：</strong><br>
            1. 删除一个会话（如 chat_1_2）<br>
            2. 从通讯录重新发送消息给同一个用户<br>
            3. 验证会话是否重新建立<br>
            4. 验证删除列表是否更新
        </div>
    </div>

    <div class="test-section">
        <h2>🔧 测试操作</h2>
        
        <button class="test-button" onclick="checkCurrentStatus()">
            1. 检查当前状态
        </button>
        
        <button class="test-button danger-button" onclick="simulateDeleteSession()">
            2. 模拟删除会话 (chat_1_2)
        </button>
        
        <button class="test-button" onclick="simulateAccessDeletedSession()">
            3. 模拟访问已删除的会话
        </button>
        
        <button class="test-button" onclick="goToContactsAndSendMessage()">
            4. 从通讯录发送消息
        </button>
        
        <button class="test-button" onclick="verifySessionRecreation()">
            5. 验证会话重建结果
        </button>
        
        <button class="test-button danger-button" onclick="resetTestData()">
            重置测试数据
        </button>
    </div>

    <div class="test-section">
        <h2>📊 测试结果</h2>
        <div id="status" class="info status">等待测试...</div>
        <div id="log" class="log">测试日志将在这里显示...</div>
    </div>

    <script>
        let logContent = '';
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logContent += `[${timestamp}] ${message}\n`;
            document.getElementById('log').textContent = logContent;
            console.log(message);
        }
        
        function setStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function checkCurrentStatus() {
            log('🔍 检查当前状态...');
            
            try {
                const deletedSessions = localStorage.getItem('deleted_chat_sessions');
                const clearedSessions = localStorage.getItem('cleared_chat_sessions');
                const sessionsCache = localStorage.getItem('chat_sessions_cache');
                
                log('📊 当前状态:');
                
                if (deletedSessions) {
                    const deleted = JSON.parse(deletedSessions);
                    log(`🗑️ 已删除的会话: ${deleted.length} 个`);
                    deleted.forEach(sessionId => {
                        log(`  - ${sessionId}`);
                    });
                } else {
                    log('🗑️ 没有已删除的会话');
                }
                
                if (clearedSessions) {
                    const cleared = JSON.parse(clearedSessions);
                    log(`🧹 已清空的会话: ${cleared.length} 个`);
                    cleared.forEach(sessionId => {
                        log(`  - ${sessionId}`);
                    });
                } else {
                    log('🧹 没有已清空的会话');
                }
                
                if (sessionsCache) {
                    const sessions = JSON.parse(sessionsCache);
                    log(`💾 缓存的会话: ${sessions.data ? sessions.data.length : 0} 个`);
                } else {
                    log('💾 没有缓存的会话');
                }
                
                setStatus('状态检查完成', 'success');
            } catch (error) {
                log(`❌ 检查状态失败: ${error.message}`);
                setStatus('检查失败', 'error');
            }
        }
        
        function simulateDeleteSession() {
            log('🗑️ 模拟删除会话 chat_1_2...');
            
            try {
                // 获取当前删除列表
                const deletedSessions = localStorage.getItem('deleted_chat_sessions');
                let deleted = deletedSessions ? JSON.parse(deletedSessions) : [];
                
                // 添加 chat_1_2 到删除列表
                if (!deleted.includes('chat_1_2')) {
                    deleted.push('chat_1_2');
                    localStorage.setItem('deleted_chat_sessions', JSON.stringify(deleted));
                    log('✅ 已将 chat_1_2 添加到删除列表');
                } else {
                    log('⚠️ chat_1_2 已在删除列表中');
                }
                
                log(`📋 当前删除列表: ${deleted.join(', ')}`);
                setStatus('会话删除模拟完成', 'success');
            } catch (error) {
                log(`❌ 模拟删除失败: ${error.message}`);
                setStatus('模拟删除失败', 'error');
            }
        }
        
        function simulateAccessDeletedSession() {
            log('🔄 模拟访问已删除的会话...');
            
            try {
                // 检查删除列表
                const deletedSessions = localStorage.getItem('deleted_chat_sessions');
                let deleted = deletedSessions ? JSON.parse(deletedSessions) : [];
                
                if (deleted.includes('chat_1_2')) {
                    log('🚫 检测到 chat_1_2 在删除列表中');
                    log('🔄 模拟用户主动访问，从删除列表中移除...');
                    
                    // 从删除列表中移除
                    deleted = deleted.filter(id => id !== 'chat_1_2');
                    localStorage.setItem('deleted_chat_sessions', JSON.stringify(deleted));
                    
                    log('✅ 已从删除列表中移除 chat_1_2');
                    log(`📋 更新后的删除列表: ${deleted.length > 0 ? deleted.join(', ') : '空'}`);
                    
                    setStatus('会话重建模拟完成', 'success');
                } else {
                    log('⚠️ chat_1_2 不在删除列表中');
                    setStatus('会话不在删除列表中', 'info');
                }
            } catch (error) {
                log(`❌ 模拟访问失败: ${error.message}`);
                setStatus('模拟访问失败', 'error');
            }
        }
        
        function goToContactsAndSendMessage() {
            log('📱 跳转到通讯录发送消息...');
            
            // 跳转到通讯录
            window.location.href = '/contacts';
        }
        
        function verifySessionRecreation() {
            log('✅ 验证会话重建结果...');
            
            try {
                const deletedSessions = localStorage.getItem('deleted_chat_sessions');
                const deleted = deletedSessions ? JSON.parse(deletedSessions) : [];
                
                if (!deleted.includes('chat_1_2')) {
                    log('✅ 验证成功: chat_1_2 不在删除列表中');
                    log('✅ 会话重建功能正常工作');
                    setStatus('会话重建验证成功', 'success');
                } else {
                    log('❌ 验证失败: chat_1_2 仍在删除列表中');
                    setStatus('会话重建验证失败', 'error');
                }
                
                // 检查是否可以正常访问聊天页面
                log('🔗 测试聊天页面访问...');
                setTimeout(() => {
                    window.location.href = '/chat/1_2';
                }, 2000);
                
            } catch (error) {
                log(`❌ 验证失败: ${error.message}`);
                setStatus('验证失败', 'error');
            }
        }
        
        function resetTestData() {
            if (confirm('确定要重置所有测试数据吗？')) {
                log('🔄 重置测试数据...');
                
                try {
                    // 清理删除列表
                    localStorage.removeItem('deleted_chat_sessions');
                    localStorage.removeItem('cleared_chat_sessions');
                    
                    log('✅ 删除列表已清空');
                    log('✅ 清空列表已清空');
                    
                    setStatus('测试数据重置完成', 'success');
                } catch (error) {
                    log(`❌ 重置失败: ${error.message}`);
                    setStatus('重置失败', 'error');
                }
            }
        }
        
        // 页面加载时自动检查状态
        window.onload = function() {
            log('🚀 会话重建测试工具已加载');
            checkCurrentStatus();
        };
    </script>
</body>
</html>
