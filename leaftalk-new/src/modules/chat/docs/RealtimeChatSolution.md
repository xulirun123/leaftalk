# å¶è¯­èŠå¤©ç³»ç»Ÿå®Œæ•´è§£å†³æ–¹æ¡ˆ

## ğŸ¯ è§£å†³çš„é—®é¢˜

### 1. èŠå¤©åˆ—è¡¨æ˜¾ç¤ºé—®é¢˜ âœ…
- **é—®é¢˜**: åˆ·æ–°é¡µé¢åèŠå¤©é¡¹æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ï¼Œåˆ‡æ¢é¡µé¢åæ¢å¤æ­£å¸¸
- **è§£å†³**: ç§»é™¤è‡ªåŠ¨åˆå§‹åŒ–æµ‹è¯•æ•°æ®ï¼Œä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤ºå‡½æ•°

### 2. åº•éƒ¨å¯¼èˆªæ é¢œè‰²é—®é¢˜ âœ…
- **é—®é¢˜**: æŒ‰é’®æ–‡å­—é¢œè‰²ä¸èƒŒæ™¯è‰²ç›¸åŒï¼Œå¯¼è‡´ä¸å¯è§
- **è§£å†³**: è°ƒæ•´é¢œè‰²æ–¹æ¡ˆï¼Œç¡®ä¿è¶³å¤Ÿå¯¹æ¯”åº¦

### 3. å®æ—¶æ¶ˆæ¯æ¥æ”¶é—®é¢˜ âœ…
- **é—®é¢˜**: å‘é€æ¶ˆæ¯å¯¹æ–¹æ²¡æ”¶åˆ°ï¼Œç¼ºå°‘å®æ—¶é€šä¿¡æœºåˆ¶
- **è§£å†³**: åˆ›å»ºå®Œæ•´çš„å®æ—¶æ¶ˆæ¯æ¥æ”¶ç³»ç»Ÿ

### 4. æ¶ˆæ¯æŒä¹…åŒ–é—®é¢˜ âœ…
- **é—®é¢˜**: èŠå¤©é¡µé¢æ¶ˆæ¯æ²¡æœ‰æ°¸ä¹…ä¿å­˜
- **è§£å†³**: å®ç°åŸºäºIndexedDBçš„æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¶è¯­èŠå¤©ç³»ç»Ÿ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å‰ç«¯ç»„ä»¶å±‚                                              â”‚
â”‚  â”œâ”€â”€ MobileHomeSimple.vue (èŠå¤©åˆ—è¡¨)                    â”‚
â”‚  â”œâ”€â”€ ChatSimple.vue (èŠå¤©é¡µé¢)                          â”‚
â”‚  â”œâ”€â”€ RealtimeMessageReceiver.vue (å®æ—¶æ¥æ”¶å™¨)           â”‚
â”‚  â””â”€â”€ MobileTabBar.vue (åº•éƒ¨å¯¼èˆª)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æœåŠ¡å±‚                                                  â”‚
â”‚  â”œâ”€â”€ realtimeMessageService.ts (å®æ—¶æ¶ˆæ¯æœåŠ¡)           â”‚
â”‚  â”œâ”€â”€ messagePersistenceService.ts (æ¶ˆæ¯æŒä¹…åŒ–)          â”‚
â”‚  â”œâ”€â”€ messageSendService.ts (æ¶ˆæ¯å‘é€æœåŠ¡)               â”‚
â”‚  â””â”€â”€ stylePreloader.ts (æ ·å¼é¢„åŠ è½½)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  çŠ¶æ€ç®¡ç†å±‚                                              â”‚
â”‚  â”œâ”€â”€ chatStore.ts (èŠå¤©çŠ¶æ€ç®¡ç†)                        â”‚
â”‚  â”œâ”€â”€ unreadStore.ts (æœªè¯»æ¶ˆæ¯ç®¡ç†)                      â”‚
â”‚  â””â”€â”€ authStore.ts (ç”¨æˆ·è®¤è¯çŠ¶æ€)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ•°æ®å­˜å‚¨å±‚                                              â”‚
â”‚  â”œâ”€â”€ IndexedDB (æœ¬åœ°æ¶ˆæ¯å­˜å‚¨)                           â”‚
â”‚  â”œâ”€â”€ localStorage (ç¼“å­˜æ•°æ®)                            â”‚
â”‚  â””â”€â”€ WebSocket (å®æ—¶é€šä¿¡)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“± æ ¸å¿ƒç»„ä»¶

### 1. å®æ—¶æ¶ˆæ¯æ¥æ”¶å™¨ (RealtimeMessageReceiver.vue)
```typescript
// åŠŸèƒ½ç‰¹æ€§
- WebSocketè¿æ¥ç®¡ç†
- è‡ªåŠ¨é‡è¿æœºåˆ¶
- æ¶ˆæ¯æ¥æ”¶å¤„ç†
- çŠ¶æ€åŒæ­¥
- é€šçŸ¥æ¨é€
```

### 2. æ¶ˆæ¯æŒä¹…åŒ–æœåŠ¡ (messagePersistenceService.ts)
```typescript
// å­˜å‚¨èƒ½åŠ›
- æ¶ˆæ¯æ°¸ä¹…å­˜å‚¨ (IndexedDB)
- ä¼šè¯ä¿¡æ¯ç®¡ç†
- åª’ä½“æ–‡ä»¶å­˜å‚¨
- æ•°æ®å¯¼å‡º/å¯¼å…¥
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®
```

### 3. æ¶ˆæ¯å‘é€æœåŠ¡ (messageSendService.ts)
```typescript
// å‘é€åŠŸèƒ½
- æ–‡æœ¬æ¶ˆæ¯å‘é€
- å›¾ç‰‡/è¯­éŸ³/è§†é¢‘å‘é€
- æ–‡ä»¶ä¼ è¾“
- å‘é€çŠ¶æ€è·Ÿè¸ª
- å¤±è´¥é‡è¯•æœºåˆ¶
```

## ğŸ”§ å…³é”®ä¿®å¤

### èŠå¤©åˆ—è¡¨æ˜¾ç¤ºä¿®å¤
```vue
<!-- ä¿®æ”¹å‰ -->
<div class="last-message" v-html="formatLastMessage(chat.lastMessage)"></div>

<!-- ä¿®æ”¹å -->
<div class="last-message">{{ getDisplayMessage(chat) }}</div>
```

### åº•éƒ¨å¯¼èˆªæ é¢œè‰²ä¿®å¤
```css
/* ä¿®æ”¹å‰ */
.tab-label {
  color: #ffffff; /* ç™½è‰²ï¼Œä¸èƒŒæ™¯å†²çª */
}

/* ä¿®æ”¹å */
.tab-label {
  color: #999999; /* ç°è‰²ï¼Œç¡®ä¿å¯è§ */
}
```

### å®æ—¶æ¶ˆæ¯æ¥æ”¶é›†æˆ
```typescript
// åœ¨ä¸»åº”ç”¨ä¸­é›†æˆ
import RealtimeMessageReceiver from './modules/chat/components/RealtimeMessageReceiver.vue'

// è‡ªåŠ¨å¤„ç†æ¶ˆæ¯æ¥æ”¶
socket.on('new_message', handleNewMessage)
```

## ğŸ’¾ æ•°æ®æµç¨‹

### å‘é€æ¶ˆæ¯æµç¨‹
```
ç”¨æˆ·è¾“å…¥ â†’ messageSendService â†’ WebSocket â†’ æœåŠ¡å™¨
    â†“
æœ¬åœ°å­˜å‚¨ â† messagePersistenceService â† çŠ¶æ€æ›´æ–°
```

### æ¥æ”¶æ¶ˆæ¯æµç¨‹
```
æœåŠ¡å™¨ â†’ WebSocket â†’ RealtimeMessageReceiver â†’ chatStore
    â†“
æœ¬åœ°å­˜å‚¨ â† messagePersistenceService â† æœªè¯»è®¡æ•°æ›´æ–°
```

### æ¶ˆæ¯æŒä¹…åŒ–æµç¨‹
```
æ¶ˆæ¯å¯¹è±¡ â†’ IndexedDBå­˜å‚¨ â†’ æœ¬åœ°ç¼“å­˜ â†’ UIæ›´æ–°
    â†“
åª’ä½“æ–‡ä»¶ â†’ Blobå­˜å‚¨ â†’ æ–‡ä»¶å¼•ç”¨ â†’ æ˜¾ç¤º
```

## ğŸ¨ æ ·å¼ä¼˜åŒ–

### å…³é”®æ ·å¼é¢„åŠ è½½
```typescript
// ç¡®ä¿æ ·å¼ç«‹å³ç”Ÿæ•ˆ
preloadCriticalStyles()
ensureStylesLoaded()
monitorStyleStatus()
```

### é¢œè‰²æ–¹æ¡ˆ
```css
/* é»˜è®¤çŠ¶æ€ */
color: #999999; /* ç°è‰²ï¼Œç¡®ä¿å¯è§ */

/* æ¿€æ´»çŠ¶æ€ */
color: #07C160; /* ç»¿è‰²ï¼Œçªå‡ºæ˜¾ç¤º */

/* èƒŒæ™¯è‰² */
background: #2c2c2c; /* æ·±ç°è‰² */
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. å‘é€æ¶ˆæ¯
```typescript
import { messageSendService } from '@/modules/chat/services/messageSendService'

// å‘é€æ–‡æœ¬æ¶ˆæ¯
await messageSendService.sendTextMessage(receiverId, 'ä½ å¥½')

// å‘é€å›¾ç‰‡æ¶ˆæ¯
await messageSendService.sendImageMessage(receiverId, imageFile)
```

### 2. æ¥æ”¶æ¶ˆæ¯
```vue
<!-- åœ¨ä¸»åº”ç”¨ä¸­è‡ªåŠ¨é›†æˆ -->
<RealtimeMessageReceiver :show-status="false" />
```

### 3. æ¶ˆæ¯æŒä¹…åŒ–
```typescript
import { messagePersistenceService } from '@/modules/chat/services/messagePersistenceService'

// è·å–å†å²æ¶ˆæ¯
const messages = await messagePersistenceService.getSessionMessages(sessionId)

// ä¿å­˜æ¶ˆæ¯
await messagePersistenceService.saveMessage(message)
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. æ ·å¼åŠ è½½ä¼˜åŒ–
- å…³é”®æ ·å¼å†…è”
- æ ·å¼é¢„åŠ è½½æœºåˆ¶
- é˜²æ­¢FOUCé—ªçƒ

### 2. æ¶ˆæ¯å­˜å‚¨ä¼˜åŒ–
- IndexedDBå¼‚æ­¥å­˜å‚¨
- åˆ†é¡µåŠ è½½å†å²æ¶ˆæ¯
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®

### 3. å®æ—¶é€šä¿¡ä¼˜åŒ–
- WebSocketè¿æ¥æ± 
- è‡ªåŠ¨é‡è¿æœºåˆ¶
- å¿ƒè·³ä¿æ´»

## ğŸ” è°ƒè¯•å·¥å…·

### 1. æ ·å¼åŠ è½½æµ‹è¯•
```
è®¿é—®: /chat/examples/StyleLoadingTest.vue
åŠŸèƒ½: æ£€æµ‹æ ·å¼åŠ è½½çŠ¶æ€å’Œæ€§èƒ½
```

### 2. æ¶ˆæ¯æ˜¾ç¤ºæµ‹è¯•
```
è®¿é—®: /chat/examples/DisplayFixTest.vue
åŠŸèƒ½: éªŒè¯æ¶ˆæ¯æ˜¾ç¤ºæ ¼å¼å’Œé¢œè‰²å¯¹æ¯”
```

### 3. æ•°æ®åŠ è½½æµ‹è¯•
```
è®¿é—®: /chat/examples/DataLoadingTest.vue
åŠŸèƒ½: ç›‘æ§æ•°æ®åŠ è½½çŠ¶æ€å’Œç¼“å­˜æƒ…å†µ
```

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸç›®æ ‡
- [ ] å®Œå–„æ¶ˆæ¯åŠ å¯†æœºåˆ¶
- [ ] æ·»åŠ æ¶ˆæ¯æ’¤å›åŠŸèƒ½
- [ ] å®ç°ç¾¤èŠåŠŸèƒ½
- [ ] ä¼˜åŒ–æ–‡ä»¶ä¼ è¾“

### é•¿æœŸç›®æ ‡
- [ ] éŸ³è§†é¢‘é€šè¯é›†æˆ
- [ ] æ¶ˆæ¯äº‘åŒæ­¥
- [ ] å¤šè®¾å¤‡åŒæ­¥
- [ ] ç¦»çº¿æ¶ˆæ¯å¤„ç†

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **WebSocketè¿æ¥**: éœ€è¦ç¡®ä¿åç«¯WebSocketæœåŠ¡æ­£å¸¸è¿è¡Œ
2. **IndexedDBæ”¯æŒ**: ç¡®ä¿æµè§ˆå™¨æ”¯æŒIndexedDB API
3. **æ–‡ä»¶ä¸Šä¼ **: éœ€è¦é…ç½®æ–‡ä»¶ä¸Šä¼ æœåŠ¡
4. **é€šçŸ¥æƒé™**: éœ€è¦ç”¨æˆ·æˆæƒæµè§ˆå™¨é€šçŸ¥æƒé™

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `RealtimeMessageReceiver.vue` - å®æ—¶æ¶ˆæ¯æ¥æ”¶å™¨
- `messagePersistenceService.ts` - æ¶ˆæ¯æŒä¹…åŒ–æœåŠ¡
- `messageSendService.ts` - æ¶ˆæ¯å‘é€æœåŠ¡
- `stylePreloader.ts` - æ ·å¼é¢„åŠ è½½å™¨
- `MobileHomeSimple.vue` - èŠå¤©åˆ—è¡¨é¡µé¢
- `ChatSimple.vue` - èŠå¤©é¡µé¢
- `MobileTabBar.vue` - åº•éƒ¨å¯¼èˆªæ 
