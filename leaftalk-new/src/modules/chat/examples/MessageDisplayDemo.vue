<template>
  <div class="message-display-demo">
    <h2>èŠå¤©é¡¹æ¶ˆæ¯æ˜¾ç¤ºæ¼”ç¤º</h2>
    
    <!-- åŠŸèƒ½è¯´æ˜ -->
    <div class="demo-info">
      <h3>æ¶ˆæ¯æ˜¾ç¤ºåŠŸèƒ½</h3>
      <ul>
        <li>âœ… æ–‡æœ¬æ¶ˆæ¯ï¼šæ˜¾ç¤ºå®Œæ•´å†…å®¹</li>
        <li>âœ… è¡¨æƒ…ç¬¦å·ï¼šæ­£ç¡®æ˜¾ç¤º emoji</li>
        <li>âœ… å›¾ç‰‡æ¶ˆæ¯ï¼šæ˜¾ç¤º [å›¾ç‰‡] æ ‡è¯†</li>
        <li>âœ… è¯­éŸ³æ¶ˆæ¯ï¼šæ˜¾ç¤º [è¯­éŸ³] æ ‡è¯†</li>
        <li>âœ… è§†é¢‘æ¶ˆæ¯ï¼šæ˜¾ç¤º [è§†é¢‘] æ ‡è¯†</li>
        <li>âœ… æ–‡ä»¶æ¶ˆæ¯ï¼šæ˜¾ç¤º [æ–‡ä»¶] æ ‡è¯†</li>
        <li>âœ… ä½ç½®æ¶ˆæ¯ï¼šæ˜¾ç¤º [ä½ç½®] æ ‡è¯†</li>
        <li>âœ… é•¿æ–‡æœ¬ï¼šè‡ªåŠ¨æˆªæ–­æ˜¾ç¤º</li>
      </ul>
    </div>

    <!-- æ¶ˆæ¯ç±»å‹æ¼”ç¤º -->
    <div class="demo-section">
      <h3>ä¸åŒæ¶ˆæ¯ç±»å‹æ¼”ç¤º</h3>
      <div class="chat-list">
        <!-- æ–‡æœ¬æ¶ˆæ¯ -->
        <div class="chat-item">
          <div class="user-avatar">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=user1" alt="å¼ ä¸‰" />
            <div class="unread-badge">1</div>
          </div>
          <div class="chat-user-info">
            <div class="user-details">
              <div class="user-name">å¼ ä¸‰</div>
              <div class="message-time-row">
                <div class="last-message" v-html="formatLastMessage('ä½ å¥½ï¼Œæœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ')"></div>
                <div class="chat-time">15:30</div>
              </div>
            </div>
          </div>
        </div>

        <!-- è¡¨æƒ…æ¶ˆæ¯ -->
        <div class="chat-item">
          <div class="user-avatar">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=user2" alt="æå››" />
          </div>
          <div class="chat-user-info">
            <div class="user-details">
              <div class="user-name">æå››</div>
              <div class="message-time-row">
                <div class="last-message" v-html="formatLastMessage('å“ˆå“ˆ :D å¤ªå¥½äº† :) <3')"></div>
                <div class="chat-time">15:25</div>
              </div>
            </div>
          </div>
        </div>

        <!-- å›¾ç‰‡æ¶ˆæ¯ -->
        <div class="chat-item">
          <div class="user-avatar">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=user3" alt="ç‹äº”" />
            <div class="unread-badge">3</div>
          </div>
          <div class="chat-user-info">
            <div class="user-details">
              <div class="user-name">ç‹äº”</div>
              <div class="message-time-row">
                <div class="last-message" v-html="formatLastMessage({ type: 'image', content: 'image.jpg' })"></div>
                <div class="chat-time">15:20</div>
              </div>
            </div>
          </div>
        </div>

        <!-- è¯­éŸ³æ¶ˆæ¯ -->
        <div class="chat-item">
          <div class="user-avatar">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=user4" alt="èµµå…­" />
            <div class="unread-badge">2</div>
          </div>
          <div class="chat-user-info">
            <div class="user-details">
              <div class="user-name">èµµå…­</div>
              <div class="message-time-row">
                <div class="last-message" v-html="formatLastMessage({ type: 'voice', content: 'voice.mp3' })"></div>
                <div class="chat-time">15:15</div>
              </div>
            </div>
          </div>
        </div>

        <!-- è§†é¢‘æ¶ˆæ¯ -->
        <div class="chat-item">
          <div class="user-avatar">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=user5" alt="é’±ä¸ƒ" />
          </div>
          <div class="chat-user-info">
            <div class="user-details">
              <div class="user-name">é’±ä¸ƒ</div>
              <div class="message-time-row">
                <div class="last-message" v-html="formatLastMessage({ type: 'video', content: 'video.mp4' })"></div>
                <div class="chat-time">15:10</div>
              </div>
            </div>
          </div>
        </div>

        <!-- æ–‡ä»¶æ¶ˆæ¯ -->
        <div class="chat-item">
          <div class="user-avatar">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=user6" alt="å­™å…«" />
            <div class="unread-badge">1</div>
          </div>
          <div class="chat-user-info">
            <div class="user-details">
              <div class="user-name">å­™å…«</div>
              <div class="message-time-row">
                <div class="last-message" v-html="formatLastMessage({ type: 'file', content: 'document.pdf' })"></div>
                <div class="chat-time">15:05</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ä½ç½®æ¶ˆæ¯ -->
        <div class="chat-item">
          <div class="user-avatar">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=user7" alt="å‘¨ä¹" />
          </div>
          <div class="chat-user-info">
            <div class="user-details">
              <div class="user-name">å‘¨ä¹</div>
              <div class="message-time-row">
                <div class="last-message" v-html="formatLastMessage({ type: 'location', content: 'åŒ—äº¬å¸‚æœé˜³åŒº' })"></div>
                <div class="chat-time">15:00</div>
              </div>
            </div>
          </div>
        </div>

        <!-- é•¿æ–‡æœ¬æ¶ˆæ¯ -->
        <div class="chat-item">
          <div class="user-avatar">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=user8" alt="å´å" />
            <div class="unread-badge">5</div>
          </div>
          <div class="chat-user-info">
            <div class="user-details">
              <div class="user-name">å´å</div>
              <div class="message-time-row">
                <div class="last-message" v-html="formatLastMessage('è¿™æ˜¯ä¸€æ¡å¾ˆé•¿å¾ˆé•¿çš„æ¶ˆæ¯å†…å®¹ï¼Œç”¨æ¥æµ‹è¯•é•¿æ–‡æœ¬çš„æ˜¾ç¤ºæ•ˆæœå’Œæˆªæ–­åŠŸèƒ½ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½æ­£ç¡®å¤„ç†')"></div>
                <div class="chat-time">14:55</div>
              </div>
            </div>
          </div>
        </div>

        <!-- è‡ªå®šä¹‰è¡¨æƒ… -->
        <div class="chat-item">
          <div class="user-avatar">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=user9" alt="éƒ‘åä¸€" />
          </div>
          <div class="chat-user-info">
            <div class="user-details">
              <div class="user-name">éƒ‘åä¸€</div>
              <div class="message-time-row">
                <div class="last-message" v-html="formatLastMessage('å¥½çš„ [å¾®ç¬‘] æ²¡é—®é¢˜ [èµ]')"></div>
                <div class="chat-time">14:50</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æµ‹è¯•å·¥å…· -->
    <div class="demo-section">
      <h3>æ¶ˆæ¯æ ¼å¼åŒ–æµ‹è¯•</h3>
      <div class="test-area">
        <div class="input-group">
          <label>è¾“å…¥æ¶ˆæ¯å†…å®¹ï¼š</label>
          <input v-model="testMessage" placeholder="è¾“å…¥è¦æµ‹è¯•çš„æ¶ˆæ¯å†…å®¹" />
        </div>
        <div class="input-group">
          <label>æ¶ˆæ¯ç±»å‹ï¼š</label>
          <select v-model="testMessageType">
            <option value="text">æ–‡æœ¬</option>
            <option value="image">å›¾ç‰‡</option>
            <option value="voice">è¯­éŸ³</option>
            <option value="video">è§†é¢‘</option>
            <option value="file">æ–‡ä»¶</option>
            <option value="location">ä½ç½®</option>
          </select>
        </div>
        <div class="result">
          <strong>æ ¼å¼åŒ–ç»“æœï¼š</strong>
          <div class="formatted-message" v-html="getTestResult()"></div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'

// æµ‹è¯•æ•°æ®
const testMessage = ref('ä½ å¥½ :) è¿™æ˜¯æµ‹è¯• [å¾®ç¬‘]')
const testMessageType = ref('text')

// æ ¼å¼åŒ–æœ€åä¸€æ¡æ¶ˆæ¯å†…å®¹ï¼ˆå¤åˆ¶ä¸»ç»„ä»¶çš„é€»è¾‘ï¼‰
const formatLastMessage = (lastMessage: any): string => {
  if (!lastMessage) {
    return 'æš‚æ— æ¶ˆæ¯'
  }

  if (typeof lastMessage === 'string') {
    return formatMessageText(lastMessage)
  }

  if (typeof lastMessage === 'object') {
    switch (lastMessage.type) {
      case 'text':
        return formatMessageText(lastMessage.content || '')
      case 'image':
        return '<span class="message-type-indicator">[å›¾ç‰‡]</span>'
      case 'voice':
        return '<span class="message-type-indicator">[è¯­éŸ³]</span>'
      case 'video':
        return '<span class="message-type-indicator">[è§†é¢‘]</span>'
      case 'file':
        return '<span class="message-type-indicator">[æ–‡ä»¶]</span>'
      case 'location':
        return '<span class="message-type-indicator">[ä½ç½®]</span>'
      case 'emoji':
        return formatMessageText(lastMessage.content || '')
      case 'sticker':
        return '<span class="message-type-indicator">[è¡¨æƒ…]</span>'
      default:
        return formatMessageText(lastMessage.content || lastMessage.text || 'æœªçŸ¥æ¶ˆæ¯')
    }
  }

  return 'æš‚æ— æ¶ˆæ¯'
}

const formatMessageText = (text: string): string => {
  if (!text) return ''
  
  let formattedText = text
  
  const emojiMap: Record<string, string> = {
    ':)': 'ğŸ˜Š',
    ':-)': 'ğŸ˜Š',
    ':(': 'ğŸ˜¢',
    ':-(': 'ğŸ˜¢',
    ':D': 'ğŸ˜ƒ',
    ':-D': 'ğŸ˜ƒ',
    ':P': 'ğŸ˜›',
    ':-P': 'ğŸ˜›',
    ';)': 'ğŸ˜‰',
    ';-)': 'ğŸ˜‰',
    ':o': 'ğŸ˜®',
    ':-o': 'ğŸ˜®',
    ':*': 'ğŸ˜˜',
    ':-*': 'ğŸ˜˜',
    '<3': 'â¤ï¸',
    '</3': 'ğŸ’”',
    ':thumbsup:': 'ğŸ‘',
    ':thumbsdown:': 'ğŸ‘',
    ':heart:': 'â¤ï¸',
    ':fire:': 'ğŸ”¥',
    ':100:': 'ğŸ’¯'
  }

  Object.entries(emojiMap).forEach(([text, emoji]) => {
    const regex = new RegExp(text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g')
    formattedText = formattedText.replace(regex, emoji)
  })

  formattedText = formattedText.replace(/\[([^\]]+)\]/g, (match, emojiName) => {
    const customEmojiMap: Record<string, string> = {
      'å¾®ç¬‘': 'ğŸ˜Š',
      'å¤§ç¬‘': 'ğŸ˜‚',
      'å“­æ³£': 'ğŸ˜­',
      'ç”Ÿæ°”': 'ğŸ˜ ',
      'æƒŠè®¶': 'ğŸ˜±',
      'çˆ±å¿ƒ': 'â¤ï¸',
      'èµ': 'ğŸ‘',
      'è¸©': 'ğŸ‘',
      'æ¡æ‰‹': 'ğŸ¤',
      'æ‹¥æŠ±': 'ğŸ¤—'
    }
    
    return customEmojiMap[emojiName] || match
  })

  if (formattedText.length > 30) {
    formattedText = formattedText.substring(0, 30) + '...'
  }

  return formattedText
}

// è·å–æµ‹è¯•ç»“æœ
const getTestResult = () => {
  if (testMessageType.value === 'text') {
    return formatLastMessage(testMessage.value)
  } else {
    return formatLastMessage({
      type: testMessageType.value,
      content: testMessage.value
    })
  }
}
</script>

<style scoped>
/* å¼•å…¥èŠå¤©é¡¹æ ·å¼ */
@import '../styles/ChatItemStyles.css';

.message-display-demo {
  padding: 20px;
  max-width: 600px;
  margin: 0 auto;
  background: #f5f5f5;
  min-height: 100vh;
}

.demo-info {
  background: white;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.demo-info ul {
  margin: 10px 0;
  padding-left: 20px;
}

.demo-info li {
  margin: 5px 0;
  color: #333;
  font-size: 14px;
}

.demo-section {
  background: white;
  border-radius: 8px;
  margin-bottom: 20px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.demo-section h3 {
  padding: 15px 20px;
  margin: 0;
  background: #f8f9fa;
  border-bottom: 1px solid #e9ecef;
  color: #333;
}

.chat-list {
  background: white;
}

.test-area {
  padding: 20px;
}

.input-group {
  margin-bottom: 15px;
}

.input-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
  color: #333;
}

.input-group input,
.input-group select {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.result {
  margin-top: 20px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 4px;
  border-left: 4px solid #07c160;
}

.formatted-message {
  margin-top: 8px;
  padding: 8px;
  background: white;
  border-radius: 4px;
  border: 1px solid #e9ecef;
  font-family: inherit;
}

h2 {
  text-align: center;
  color: #333;
  margin-bottom: 30px;
}

/* æ¶ˆæ¯ç±»å‹æŒ‡ç¤ºå™¨æ ·å¼ */
.message-type-indicator {
  color: #666;
  font-style: italic;
  background: rgba(0, 0, 0, 0.05);
  padding: 1px 4px;
  border-radius: 3px;
  font-size: 12px;
}
</style>
