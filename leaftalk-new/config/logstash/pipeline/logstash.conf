# Logstash 配置文件
# 处理叶语企业版微服务日志

input {
  # 从Filebeat接收日志
  beats {
    port => 5044
  }
  
  # 直接接收JSON格式日志
  tcp {
    port => 5000
    codec => json_lines
  }
  
  # UDP日志接收
  udp {
    port => 5000
    codec => json_lines
  }
}

filter {
  # 解析JSON日志
  if [message] {
    json {
      source => "message"
    }
  }
  
  # 添加服务标识
  if [service] {
    mutate {
      add_tag => [ "leaftalk-service" ]
    }
  }
  
  # 处理错误日志
  if [level] == "ERROR" {
    mutate {
      add_tag => [ "error" ]
    }
  }
  
  # 处理HTTP请求日志
  if [request] {
    mutate {
      add_tag => [ "http-request" ]
    }
    
    # 提取响应时间
    if [request][responseTime] {
      mutate {
        convert => { "[request][responseTime]" => "integer" }
      }
    }
    
    # 提取状态码
    if [request][statusCode] {
      mutate {
        convert => { "[request][statusCode]" => "integer" }
      }
    }
  }
  
  # 处理数据库查询日志
  if [database] {
    mutate {
      add_tag => [ "database-query" ]
    }
    
    # 提取查询时间
    if [database][duration] {
      mutate {
        convert => { "[database][duration]" => "integer" }
      }
    }
  }
  
  # 处理缓存操作日志
  if [cache] {
    mutate {
      add_tag => [ "cache-operation" ]
    }
  }
  
  # 处理业务操作日志
  if [business] {
    mutate {
      add_tag => [ "business-operation" ]
    }
  }
  
  # 处理安全事件日志
  if [security] {
    mutate {
      add_tag => [ "security-event" ]
    }
  }
  
  # 处理性能指标日志
  if [performance] {
    mutate {
      add_tag => [ "performance-metric" ]
    }
  }
  
  # 添加时间戳
  date {
    match => [ "timestamp", "ISO8601" ]
  }
  
  # 地理位置解析（如果有IP地址）
  if [request][ip] {
    geoip {
      source => "[request][ip]"
      target => "geoip"
    }
  }
  
  # 用户代理解析
  if [request][userAgent] {
    useragent {
      source => "[request][userAgent]"
      target => "user_agent"
    }
  }
}

output {
  # 输出到Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "leaftalk-logs-%{+YYYY.MM.dd}"
    template_name => "leaftalk-logs"
    template_pattern => "leaftalk-logs-*"
    template => {
      "index_patterns" => ["leaftalk-logs-*"],
      "settings" => {
        "number_of_shards" => 1,
        "number_of_replicas" => 0
      },
      "mappings" => {
        "properties" => {
          "@timestamp" => { "type" => "date" },
          "level" => { "type" => "keyword" },
          "service" => { "type" => "keyword" },
          "message" => { "type" => "text" },
          "request" => {
            "properties" => {
              "method" => { "type" => "keyword" },
              "url" => { "type" => "keyword" },
              "statusCode" => { "type" => "integer" },
              "responseTime" => { "type" => "integer" },
              "ip" => { "type" => "ip" }
            }
          },
          "database" => {
            "properties" => {
              "duration" => { "type" => "integer" },
              "sql" => { "type" => "text" }
            }
          }
        }
      }
    }
  }
  
  # 调试输出（开发环境）
  if [level] == "DEBUG" {
    stdout {
      codec => rubydebug
    }
  }
}
