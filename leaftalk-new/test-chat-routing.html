<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天路由测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #07C160;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            display: block;
            width: 100%;
            text-align: left;
        }
        .test-button:hover {
            background: #06A050;
        }
        .danger-button {
            background: #FF4444;
        }
        .danger-button:hover {
            background: #DD2222;
        }
        .log {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .url-display {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>🧪 聊天路由和删除功能测试</h1>
    
    <div class="test-section">
        <h2>📋 测试说明</h2>
        <div class="info status">
            <strong>测试目标：</strong><br>
            1. 验证从通讯录发送消息的路由是否正确<br>
            2. 验证聊天页面的删除功能是否生效<br>
            3. 验证删除后的页面跳转是否正常
        </div>
    </div>

    <div class="test-section">
        <h2>🔗 路由测试</h2>
        <p>测试不同的聊天路由格式：</p>
        
        <button class="test-button" onclick="testRoute('1_2')">
            测试正确格式: /chat/1_2 (用户1和用户2)
        </button>
        <div class="url-display">URL: /chat/1_2</div>
        
        <button class="test-button" onclick="testRoute('chat_1_2')">
            测试错误格式: /chat/chat_1_2 (会导致问题)
        </button>
        <div class="url-display">URL: /chat/chat_1_2</div>
        
        <button class="test-button" onclick="testRoute('2')">
            测试单用户ID: /chat/2 (可能有问题)
        </button>
        <div class="url-display">URL: /chat/2</div>
    </div>

    <div class="test-section">
        <h2>🗑️ 删除功能测试</h2>
        <p>在聊天页面中测试删除功能：</p>
        
        <button class="test-button" onclick="goToChat()">
            1. 进入聊天主页
        </button>
        
        <button class="test-button" onclick="goToChatPage()">
            2. 进入聊天页面 (1_2)
        </button>
        
        <button class="test-button danger-button" onclick="testDeleteInConsole()">
            3. 在控制台测试删除功能
        </button>
        
        <button class="test-button danger-button" onclick="testClearInConsole()">
            4. 在控制台测试清空功能
        </button>
    </div>

    <div class="test-section">
        <h2>🔍 状态检查</h2>
        <button class="test-button" onclick="checkDeleteStatus()">检查删除状态</button>
        <button class="test-button" onclick="checkLocalStorage()">检查本地存储</button>
        <button class="test-button" onclick="clearAllData()">清理所有数据</button>
    </div>

    <div class="test-section">
        <h2>📊 测试结果</h2>
        <div id="status" class="info status">等待测试...</div>
        <div id="log" class="log">测试日志将在这里显示...</div>
    </div>

    <script>
        let logContent = '';
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logContent += `[${timestamp}] ${message}\n`;
            document.getElementById('log').textContent = logContent;
            console.log(message);
        }
        
        function setStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function testRoute(chatId) {
            log(`🔗 测试路由: /chat/${chatId}`);
            
            try {
                const url = `/chat/${chatId}`;
                log(`📍 跳转到: ${url}`);
                window.location.href = url;
            } catch (error) {
                log(`❌ 路由测试失败: ${error.message}`);
                setStatus('路由测试失败', 'error');
            }
        }
        
        function goToChat() {
            log('🏠 跳转到聊天主页');
            window.location.href = '/';
        }
        
        function goToChatPage() {
            log('💬 跳转到聊天页面 (1_2)');
            window.location.href = '/chat/1_2';
        }
        
        function testDeleteInConsole() {
            log('🗑️ 在控制台测试删除功能...');
            log('请在浏览器控制台中输入: testDeleteFunction()');
            
            // 打开控制台
            if (window.console && window.console.log) {
                console.log('🧪 删除功能测试');
                console.log('请在聊天页面中输入: testDeleteFunction()');
                console.log('这将测试删除当前会话的功能');
            }
            
            setStatus('请在控制台中输入 testDeleteFunction()', 'info');
        }
        
        function testClearInConsole() {
            log('🧹 在控制台测试清空功能...');
            log('请在浏览器控制台中输入: testClearFunction()');
            
            // 打开控制台
            if (window.console && window.console.log) {
                console.log('🧪 清空功能测试');
                console.log('请在聊天页面中输入: testClearFunction()');
                console.log('这将测试清空当前会话消息的功能');
            }
            
            setStatus('请在控制台中输入 testClearFunction()', 'info');
        }
        
        function checkDeleteStatus() {
            log('🔍 检查删除状态...');
            
            try {
                const deletedSessions = localStorage.getItem('deleted_chat_sessions');
                const clearedSessions = localStorage.getItem('cleared_chat_sessions');
                
                if (deletedSessions) {
                    const deleted = JSON.parse(deletedSessions);
                    log(`🗑️ 已删除的会话: ${deleted.length} 个`);
                    deleted.forEach(sessionId => {
                        log(`  - ${sessionId}`);
                    });
                } else {
                    log('🗑️ 没有已删除的会话');
                }
                
                if (clearedSessions) {
                    const cleared = JSON.parse(clearedSessions);
                    log(`🧹 已清空的会话: ${cleared.length} 个`);
                    cleared.forEach(sessionId => {
                        log(`  - ${sessionId}`);
                    });
                } else {
                    log('🧹 没有已清空的会话');
                }
                
                setStatus('删除状态检查完成', 'success');
            } catch (error) {
                log(`❌ 检查删除状态失败: ${error.message}`);
                setStatus('检查失败', 'error');
            }
        }
        
        function checkLocalStorage() {
            log('💾 检查本地存储...');
            
            try {
                const keys = Object.keys(localStorage);
                const chatKeys = keys.filter(key => 
                    key.includes('chat') || 
                    key.includes('message') || 
                    key.includes('deleted') ||
                    key.includes('cleared')
                );
                
                log(`💾 聊天相关存储项: ${chatKeys.length} 个`);
                
                chatKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    const size = value ? value.length : 0;
                    log(`  - ${key}: ${size} 字符`);
                });
                
                setStatus('本地存储检查完成', 'success');
            } catch (error) {
                log(`❌ 检查本地存储失败: ${error.message}`);
                setStatus('检查失败', 'error');
            }
        }
        
        function clearAllData() {
            if (confirm('确定要清理所有聊天数据吗？')) {
                log('🧹 开始清理所有数据...');
                
                try {
                    const keys = Object.keys(localStorage);
                    let clearedCount = 0;
                    
                    keys.forEach(key => {
                        if (key.includes('chat') || 
                            key.includes('message') || 
                            key.includes('deleted') ||
                            key.includes('cleared') ||
                            key.includes('leaftalk')) {
                            localStorage.removeItem(key);
                            clearedCount++;
                            log(`🗑️ 删除: ${key}`);
                        }
                    });
                    
                    // 清理IndexedDB
                    const deleteDB = indexedDB.deleteDatabase('leaftalk-messages');
                    deleteDB.onsuccess = () => {
                        log('✅ IndexedDB数据库已删除');
                    };
                    
                    log(`✅ 数据清理完成，删除了 ${clearedCount} 个项`);
                    setStatus(`数据清理完成，删除了 ${clearedCount} 个项`, 'success');
                } catch (error) {
                    log(`❌ 清理失败: ${error.message}`);
                    setStatus('清理失败', 'error');
                }
            }
        }
        
        // 页面加载时自动检查状态
        window.onload = function() {
            log('🚀 页面加载完成');
            log('当前URL: ' + window.location.href);
            checkDeleteStatus();
        };
    </script>
</body>
</html>
