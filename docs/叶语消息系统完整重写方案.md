# å¶è¯­æ¶ˆæ¯ç³»ç»Ÿå®Œæ•´é‡å†™æ–¹æ¡ˆ v3.0

## ğŸ¯ ç³»ç»Ÿæ€»ä½“ç›®æ ‡

- **åŠŸèƒ½å®Œæ•´**ï¼šæ”¯æŒæ–‡æœ¬ã€è¯­éŸ³ã€å›¾ç‰‡ã€è§†é¢‘ã€ä½ç½®ã€çº¢åŒ…ã€è½¬è´¦ç­‰æ‰€æœ‰æ¶ˆæ¯ç±»å‹
- **å®æ—¶å‡†ç¡®**ï¼šåœ¨çº¿ç¦»çº¿çŠ¶æ€ä¸‹çš„æ¶ˆæ¯ã€æœªè¯»è®¡æ•°ã€æœ€åæ¶ˆæ¯å®æ—¶æ›´æ–°
- **æ•°æ®å®‰å…¨**ï¼šåˆ†ç±»å­˜å‚¨ç­–ç•¥ï¼Œç”¨æˆ·éšç§ä¿æŠ¤
- **ç”¨æˆ·ä½“éªŒ**ï¼šæµç•…çš„äº¤äº’ï¼Œæ™ºèƒ½çš„åŠŸèƒ½é›†æˆ

## ğŸ“Š å®Œæ•´æ•°æ®ç»“æ„è®¾è®¡

### æ ¸å¿ƒæ¶ˆæ¯ç»“æ„
```typescript
interface Message {
  id: string                    // å”¯ä¸€IDï¼šmsg_æ—¶é—´æˆ³_éšæœºæ•°
  chatId: string               // èŠå¤©IDï¼ˆå¯¹æ–¹ç”¨æˆ·IDï¼‰
  senderId: string             // å‘é€è€…ID
  receiverId: string           // æ¥æ”¶è€…ID
  content: string              // æ¶ˆæ¯å†…å®¹
  type: MessageType            // æ¶ˆæ¯ç±»å‹
  timestamp: number            // å‘é€æ—¶é—´æˆ³
  status: MessageStatus        // æ¶ˆæ¯çŠ¶æ€
  isSelf: boolean             // æ˜¯å¦è‡ªå·±å‘é€
  retryCount?: number         // é‡è¯•æ¬¡æ•°
  isDeleted?: boolean         // æ˜¯å¦å·²åˆ é™¤
  
  // åª’ä½“æ–‡ä»¶å­—æ®µ
  fileUrl?: string            // æœåŠ¡å™¨æ–‡ä»¶URL
  localPath?: string          // æœ¬åœ°æ–‡ä»¶è·¯å¾„
  fileSize?: number           // æ–‡ä»¶å¤§å°
  duration?: number           // è¯­éŸ³/è§†é¢‘æ—¶é•¿
  thumbnail?: string          // ç¼©ç•¥å›¾
  fileName?: string           // åŸå§‹æ–‡ä»¶å
  mimeType?: string           // æ–‡ä»¶ç±»å‹
  
  // ä½ç½®ä¿¡æ¯å­—æ®µ
  latitude?: number           // çº¬åº¦
  longitude?: number          // ç»åº¦
  address?: string            // åœ°å€æè¿°
  locationName?: string       // ä½ç½®åç§°
  
  // çº¢åŒ…è½¬è´¦å­—æ®µ
  amount?: number             // é‡‘é¢
  redpacketId?: string        // çº¢åŒ…ID
  transferId?: string         // è½¬è´¦ID
  paymentStatus?: PaymentStatus
  remark?: string             // å¤‡æ³¨
  
  // åç‰‡å­—æ®µ
  contactCard?: {
    userId: string
    name: string
    avatar: string
    phone?: string
    yeyuId?: string
  }
  
  // è¯­éŸ³è½¬æ–‡å­—å­—æ®µ
  transcription?: string      // è¯­éŸ³è½¬æ–‡å­—ç»“æœ
  transcriptionStatus?: 'pending' | 'completed' | 'failed'
  
  // é€šè¯è®°å½•å­—æ®µ
  callDuration?: number       // é€šè¯æ—¶é•¿
  callType?: 'voice' | 'video'
  callStatus?: 'completed' | 'missed' | 'rejected' | 'failed'
}

enum MessageType {
  TEXT = 'text',
  IMAGE = 'image',
  VOICE = 'voice',
  VIDEO = 'video',
  FILE = 'file',
  LOCATION = 'location',
  REDPACKET = 'redpacket',
  TRANSFER = 'transfer',
  CONTACT_CARD = 'contact_card',
  VOICE_CALL = 'voice_call',
  VIDEO_CALL = 'video_call',
  SYSTEM = 'system'
}

enum MessageStatus {
  SENDING = 'sending',
  SENT = 'sent',
  DELIVERED = 'delivered',
  READ = 'read',
  FAILED = 'failed'
}

enum PaymentStatus {
  PENDING = 'pending',
  COMPLETED = 'completed',
  EXPIRED = 'expired',
  REFUNDED = 'refunded'
}
```

### èŠå¤©åˆ—è¡¨ç»“æ„
```typescript
interface Chat {
  id: string                  // èŠå¤©IDï¼ˆå¯¹æ–¹ç”¨æˆ·IDï¼‰
  userId: string              // å¯¹æ–¹ç”¨æˆ·ID
  name: string                // å¯¹æ–¹å§“å
  avatar: string              // å¯¹æ–¹å¤´åƒ
  lastMessage: string         // æœ€åä¸€æ¡æ¶ˆæ¯å†…å®¹
  lastMessageType: MessageType // æœ€åæ¶ˆæ¯ç±»å‹
  lastMessageTime: number     // æœ€åæ¶ˆæ¯æ—¶é—´
  unreadCount: number         // æœªè¯»æ¶ˆæ¯æ•°
  isPinned: boolean          // æ˜¯å¦ç½®é¡¶
  isMuted: boolean           // æ˜¯å¦å…æ‰“æ‰°
  isDeleted: boolean         // æ˜¯å¦å·²åˆ é™¤
  createdAt: number          // èŠå¤©åˆ›å»ºæ—¶é—´
  updatedAt: number          // æœ€åæ›´æ–°æ—¶é—´
  
  // åœ¨çº¿çŠ¶æ€
  isOnline: boolean          // å¯¹æ–¹æ˜¯å¦åœ¨çº¿
  lastSeen?: number          // æœ€ååœ¨çº¿æ—¶é—´
  
  // è‰ç¨¿æ¶ˆæ¯
  draftMessage?: string      // è‰ç¨¿å†…å®¹
  draftTime?: number         // è‰ç¨¿æ—¶é—´
}
```

### æœªè¯»è®¡æ•°ç®¡ç†ç»“æ„
```typescript
interface UnreadManager {
  totalUnread: number         // æ€»æœªè¯»æ•°
  chatUnreads: Map<string, number>  // å„èŠå¤©æœªè¯»æ•°
  mutedChats: Set<string>     // å…æ‰“æ‰°èŠå¤©åˆ—è¡¨
  
  // è®¡ç®—æ–¹æ³•
  getTotalUnread(): number    // è·å–æ€»æœªè¯»æ•°ï¼ˆæ’é™¤å…æ‰“æ‰°ï¼‰
  getChatUnread(chatId: string): number  // è·å–æŒ‡å®šèŠå¤©æœªè¯»æ•°
  incrementUnread(chatId: string): void  // å¢åŠ æœªè¯»æ•°
  clearUnread(chatId: string): void      // æ¸…é™¤æœªè¯»æ•°
  markAsRead(chatId: string, messageId?: string): void  // æ ‡è®°å·²è¯»
}
```

## ğŸ”„ æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 1. æ¶ˆæ¯å‘é€å®Œæ•´æµç¨‹
```
ç”¨æˆ·æ“ä½œ â†’ æ¶ˆæ¯ç±»å‹åˆ¤æ–­ â†’ é¢„å¤„ç†ï¼ˆæ–‡ä»¶ä¸Šä¼ /ä½ç½®è·å–ç­‰ï¼‰ â†’ åˆ›å»ºæ¶ˆæ¯å¯¹è±¡
    â†“
ç«‹å³æ˜¾ç¤º(status: sending) â†’ HTTP APIå‘é€ â†’ å®æ—¶æ¨é€ç»™æ¥æ”¶è€… â†’ æ›´æ–°å‘é€çŠ¶æ€
    â†“                          â†“                â†“
æ›´æ–°èŠå¤©åˆ—è¡¨æœ€åæ¶ˆæ¯        æœåŠ¡å™¨å­˜å‚¨        æ¥æ”¶è€…å®æ—¶æ”¶åˆ°/ç¦»çº¿æš‚å­˜
    â†“
å‘é€å¤±è´¥åˆ™é‡è¯•(æœ€å¤š3æ¬¡) â†’ æœ€ç»ˆæ ‡è®°ä¸ºfailed
```

### 2. æ¶ˆæ¯æ¥æ”¶å®Œæ•´æµç¨‹
```
åœ¨çº¿æ¥æ”¶ï¼š
ç»Ÿä¸€å®æ—¶æœåŠ¡æ¨é€ â†’ é»‘åå•æ£€æŸ¥ â†’ æ¶ˆæ¯å»é‡ â†’ æ·»åŠ åˆ°Store â†’ æ›´æ–°èŠå¤©åˆ—è¡¨
                      â†“              â†“           â†“            â†“
                  æ‹’æ”¶åˆ™å¿½ç•¥      åŸºäºIDå»é‡    ä¿å­˜æœ¬åœ°     æ›´æ–°æœ€åæ¶ˆæ¯
                                                              â†“
                                                        æ›´æ–°æœªè¯»è®¡æ•°
                                                              â†“
                                                        æ›´æ–°åº•éƒ¨å¯¼èˆª

ç¦»çº¿æ¥æ”¶ï¼š
æœåŠ¡å™¨æš‚å­˜æ¶ˆæ¯ â†’ è®°å½•æœªè¯»è®¡æ•° â†’ ç”¨æˆ·ä¸Šçº¿ â†’ æ¨é€ç¦»çº¿æ¶ˆæ¯åŒ… â†’ æ‰¹é‡å¤„ç†
                    â†“              â†“              â†“
                æœåŠ¡å™¨ç«¯è®¡æ•°      æ£€æµ‹è¿æ¥        å»é‡+æ˜¾ç¤º+è®¡æ•°æ›´æ–°
```

### 3. æœªè¯»è®¡æ•°ç²¾ç¡®ç®¡ç†
```
æ¶ˆæ¯æ¥æ”¶æ—¶ï¼š
æ£€æŸ¥å½“å‰é¡µé¢ â†’ æ˜¯å½“å‰èŠå¤©é¡µé¢ï¼šç›´æ¥æ ‡è®°å·²è¯»ï¼Œä¸å¢åŠ æœªè¯»
                â†“
            éå½“å‰èŠå¤©ï¼šå¢åŠ æœªè¯»è®¡æ•° â†’ æ›´æ–°èŠå¤©åˆ—è¡¨ â†’ æ›´æ–°åº•éƒ¨å¯¼èˆªçº¢ç‚¹

ç”¨æˆ·è¿›å…¥èŠå¤©é¡µé¢ï¼š
åŠ è½½æ¶ˆæ¯ â†’ æ¸…é™¤è¯¥èŠå¤©æœªè¯»è®¡æ•° â†’ å‘é€å·²è¯»å›æ‰§ç»™æœåŠ¡å™¨ â†’ æ›´æ–°æ€»æœªè¯»è®¡æ•°

ç¦»çº¿çŠ¶æ€ï¼š
æœåŠ¡å™¨æ¥æ”¶æ¶ˆæ¯ â†’ æœåŠ¡å™¨ç«¯æœªè¯»è®¡æ•°+1 â†’ ç”¨æˆ·ä¸Šçº¿ â†’ åŒæ­¥æœªè¯»è®¡æ•°åˆ°å®¢æˆ·ç«¯
```

### 4. æœ€åä¸€æ¡æ¶ˆæ¯å®æ—¶æ›´æ–°
```
åœ¨çº¿çŠ¶æ€ï¼š
å‘é€/æ¥æ”¶æ¶ˆæ¯ â†’ ç«‹å³æ›´æ–°èŠå¤©é¡¹lastMessage â†’ æ›´æ–°lastMessageTime â†’ é‡æ–°æ’åºèŠå¤©åˆ—è¡¨
                                              â†“
                                        ä¿å­˜åˆ°IndexedDB

ç¦»çº¿çŠ¶æ€ï¼š
æœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯ â†’ æ›´æ–°æœåŠ¡å™¨ç«¯èŠå¤©è®°å½• â†’ ç”¨æˆ·ä¸Šçº¿ â†’ æ¨é€æœ€æ–°èŠå¤©çŠ¶æ€
                                                    â†“
                                            æ›´æ–°æœ¬åœ°èŠå¤©åˆ—è¡¨ â†’ é‡æ–°æ’åº
```

## ğŸ’¾ å­˜å‚¨ç³»ç»Ÿè¯¦ç»†è®¾è®¡

### IndexedDBå­˜å‚¨ç»“æ„
```typescript
// æ•°æ®åº“ï¼šYeYuMessages v2
const dbSchema = {
  // æ¶ˆæ¯è¡¨
  messages: {
    keyPath: 'id',
    indexes: [
      { name: 'chatId', keyPath: 'chatId' },
      { name: 'timestamp', keyPath: 'timestamp' },
      { name: 'type', keyPath: 'type' },
      { name: 'status', keyPath: 'status' }
    ]
  },
  
  // èŠå¤©è¡¨
  chats: {
    keyPath: 'id',
    indexes: [
      { name: 'lastMessageTime', keyPath: 'lastMessageTime' },
      { name: 'unreadCount', keyPath: 'unreadCount' },
      { name: 'isPinned', keyPath: 'isPinned' }
    ]
  },
  
  // æœªè¯»è®¡æ•°è¡¨
  unreads: {
    keyPath: 'chatId',
    indexes: [
      { name: 'count', keyPath: 'count' },
      { name: 'updatedAt', keyPath: 'updatedAt' }
    ]
  },
  
  // è‰ç¨¿è¡¨
  drafts: {
    keyPath: 'chatId',
    indexes: [
      { name: 'updatedAt', keyPath: 'updatedAt' }
    ]
  }
}
```

### åª’ä½“æ–‡ä»¶å­˜å‚¨ç­–ç•¥
```typescript
// CacheStorageåˆ†ç±»å­˜å‚¨
const cacheStorageStrategy = {
  // å›¾ç‰‡ç¼“å­˜
  'yeyu-images-v1': {
    pattern: /\.(jpg|jpeg|png|gif|webp)$/i,
    maxSize: '100MB',
    retention: '7å¤©'
  },
  
  // è¯­éŸ³ç¼“å­˜
  'yeyu-voices-v1': {
    pattern: /\.(mp3|wav|m4a|aac)$/i,
    maxSize: '50MB',
    retention: '7å¤©'
  },
  
  // è§†é¢‘ç¼“å­˜
  'yeyu-videos-v1': {
    pattern: /\.(mp4|mov|avi)$/i,
    maxSize: '200MB',
    retention: '7å¤©'
  },
  
  // æ–‡ä»¶ç¼“å­˜
  'yeyu-files-v1': {
    pattern: /\.(pdf|doc|docx|xls|xlsx|ppt|pptx)$/i,
    maxSize: '100MB',
    retention: '7å¤©'
  }
}
```

### æ•°æ®æ¸…ç†ç­–ç•¥
```typescript
const dataCleanupPolicy = {
  // è‡ªåŠ¨æ¸…ç†è§„åˆ™
  autoCleanup: {
    textMessages: {
      client: '1å¹´',
      server: '1å¹´'
    },
    mediaMessages: {
      client: '7å¤©',
      server: '1ä¸ªæœˆ'
    },
    redpacketTransfer: {
      client: 'æ°¸ä¹…',
      server: 'æ°¸ä¹…ï¼ˆç›´åˆ°ç”¨æˆ·æ³¨é”€ï¼‰'
    },
    callRecords: {
      client: '30å¤©',
      server: '90å¤©'
    },
    locationMessages: {
      client: '30å¤©',
      server: '90å¤©'
    }
  },
  
  // ç”¨æˆ·æ“ä½œæ¸…ç†
  userActions: {
    deleteChatItem: {
      action: 'clearLocalOnly',
      scope: ['messages', 'media', 'unreads', 'drafts']
    },
    accountDeletion: {
      action: 'clearAll',
      preserve: ['genealogy'],
      scope: ['messages', 'media', 'unreads', 'redpackets', 'transfers']
    }
  }
}
```

## ğŸ¤ æ¶ˆæ¯åŠŸèƒ½æ¨¡å—è¯¦ç»†è®¾è®¡

### 1. æ–‡æœ¬æ¶ˆæ¯æ¨¡å—
```typescript
interface TextMessageModule {
  // åŸºç¡€æ–‡æœ¬
  sendText(content: string, chatId: string): Promise<Message>

  // @æåŠåŠŸèƒ½
  sendMention(content: string, mentionUsers: string[], chatId: string): Promise<Message>

  // è¡¨æƒ…åŒ…
  sendEmoji(emojiCode: string, chatId: string): Promise<Message>

  // æ–‡æœ¬æ ¼å¼åŒ–
  formatText(content: string): string  // æ”¯æŒç²—ä½“ã€æ–œä½“ç­‰
}
```

### 2. è¯­éŸ³æ¶ˆæ¯æ¨¡å—
```typescript
interface VoiceMessageModule {
  // å½•éŸ³åŠŸèƒ½
  startRecording(): Promise<void>
  stopRecording(): Promise<Blob>
  cancelRecording(): void

  // è¯­éŸ³å‘é€
  sendVoice(audioBlob: Blob, duration: number, chatId: string): Promise<Message>

  // è¯­éŸ³è½¬æ–‡å­—
  transcribeVoice(audioBlob: Blob): Promise<string>

  // è¯­éŸ³æ’­æ”¾
  playVoice(message: Message): Promise<void>
  pauseVoice(): void

  // è¯­éŸ³è¾“å…¥ï¼ˆå®æ—¶è½¬æ–‡å­—ï¼‰
  startVoiceInput(callback: (text: string) => void): Promise<void>
  stopVoiceInput(): void
}
```

### 3. å›¾ç‰‡æ¶ˆæ¯æ¨¡å—
```typescript
interface ImageMessageModule {
  // æ‹ç…§
  takePhoto(): Promise<Blob>

  // é€‰æ‹©å›¾ç‰‡
  selectImage(): Promise<Blob[]>

  // å›¾ç‰‡ç¼–è¾‘
  editImage(imageBlob: Blob): Promise<Blob>

  // å‘é€å›¾ç‰‡
  sendImage(imageBlob: Blob, chatId: string): Promise<Message>

  // å›¾ç‰‡é¢„è§ˆ
  previewImage(message: Message): void

  // å›¾ç‰‡å‹ç¼©
  compressImage(imageBlob: Blob, quality: number): Promise<Blob>
}
```

### 4. è§†é¢‘æ¶ˆæ¯æ¨¡å—
```typescript
interface VideoMessageModule {
  // å½•åˆ¶è§†é¢‘
  startVideoRecording(): Promise<void>
  stopVideoRecording(): Promise<Blob>

  // é€‰æ‹©è§†é¢‘
  selectVideo(): Promise<Blob>

  // å‘é€è§†é¢‘
  sendVideo(videoBlob: Blob, thumbnail: Blob, duration: number, chatId: string): Promise<Message>

  // è§†é¢‘æ’­æ”¾
  playVideo(message: Message): void

  // ç”Ÿæˆç¼©ç•¥å›¾
  generateThumbnail(videoBlob: Blob): Promise<Blob>
}
```

### 5. ä½ç½®æ¶ˆæ¯æ¨¡å—
```typescript
interface LocationMessageModule {
  // è·å–å½“å‰ä½ç½®
  getCurrentLocation(): Promise<LocationInfo>

  // é€‰æ‹©ä½ç½®
  selectLocation(): Promise<LocationInfo>

  // å‘é€ä½ç½®
  sendLocation(location: LocationInfo, chatId: string): Promise<Message>

  // å®æ—¶ä½ç½®å…±äº«
  startLocationSharing(chatId: string, duration: number): Promise<void>
  stopLocationSharing(chatId: string): void

  // ä½ç½®æ˜¾ç¤º
  showLocationOnMap(message: Message): void
}

interface LocationInfo {
  latitude: number
  longitude: number
  address: string
  name?: string
  accuracy?: number
}
```

### 6. çº¢åŒ…è½¬è´¦æ¨¡å—
```typescript
interface PaymentMessageModule {
  // å‘é€çº¢åŒ…
  sendRedpacket(amount: number, count: number, remark: string, chatId: string): Promise<Message>

  // å‘é€è½¬è´¦
  sendTransfer(amount: number, remark: string, chatId: string): Promise<Message>

  // é¢†å–çº¢åŒ…
  claimRedpacket(redpacketId: string): Promise<ClaimResult>

  // æ¥æ”¶è½¬è´¦
  acceptTransfer(transferId: string): Promise<TransferResult>

  // æŸ¥çœ‹çº¢åŒ…è¯¦æƒ…
  getRedpacketDetail(redpacketId: string): Promise<RedpacketDetail>

  // æŸ¥çœ‹è½¬è´¦è¯¦æƒ…
  getTransferDetail(transferId: string): Promise<TransferDetail>
}
```

### 7. é€šè¯æ¨¡å—
```typescript
interface CallMessageModule {
  // å‘èµ·è¯­éŸ³é€šè¯
  startVoiceCall(userId: string): Promise<CallSession>

  // å‘èµ·è§†é¢‘é€šè¯
  startVideoCall(userId: string): Promise<CallSession>

  // æ¥å¬é€šè¯
  answerCall(callId: string): Promise<void>

  // æ‹’ç»é€šè¯
  rejectCall(callId: string): Promise<void>

  // æŒ‚æ–­é€šè¯
  endCall(callId: string): Promise<void>

  // é€šè¯è®°å½•
  saveCallRecord(callSession: CallSession): Promise<Message>
}
```

### 8. åç‰‡æ¶ˆæ¯æ¨¡å—
```typescript
interface ContactCardModule {
  // å‘é€åç‰‡
  sendContactCard(contactInfo: ContactInfo, chatId: string): Promise<Message>

  // æ·»åŠ è”ç³»äºº
  addContactFromCard(message: Message): Promise<void>

  // æŸ¥çœ‹åç‰‡è¯¦æƒ…
  viewContactCard(message: Message): void
}

interface ContactInfo {
  userId: string
  name: string
  avatar: string
  phone?: string
  yeyuId?: string
  company?: string
  title?: string
}
```

## ğŸ”§ æŠ€æœ¯å®ç°æ¶æ„

### ç»Ÿä¸€æ¶ˆæ¯Store
```typescript
class MessageStore {
  // æ ¸å¿ƒçŠ¶æ€
  private messages = new Map<string, Message[]>()
  private chats = ref<Chat[]>([])
  private unreadManager = new UnreadManager()
  private currentChatId = ref<string>('')

  // å­˜å‚¨ç®¡ç†å™¨
  private messageStorage = new MessageStorage()
  private mediaManager = new MediaFileManager()

  // åŠŸèƒ½æ¨¡å—
  private textModule = new TextMessageModule()
  private voiceModule = new VoiceMessageModule()
  private imageModule = new ImageMessageModule()
  private videoModule = new VideoMessageModule()
  private locationModule = new LocationMessageModule()
  private paymentModule = new PaymentMessageModule()
  private callModule = new CallMessageModule()
  private contactModule = new ContactCardModule()

  // æ ¸å¿ƒæ–¹æ³•
  async sendMessage(type: MessageType, data: any, chatId: string): Promise<Message>
  async receiveMessage(messageData: any): Promise<void>
  async loadMessages(chatId: string, page: number): Promise<Message[]>
  async markAsRead(chatId: string, messageId?: string): Promise<void>
  async deleteChat(chatId: string): Promise<void>
  async clearAllData(): Promise<void>
}
```

### å®æ—¶æœåŠ¡é›†æˆ
```typescript
class RealtimeMessageHandler {
  private unifiedService = window.unifiedRealtimeService

  async initialize() {
    // ç›‘å¬æ–°æ¶ˆæ¯
    this.unifiedService.subscribe('chat', 'new_message', this.handleNewMessage)

    // ç›‘å¬æ¶ˆæ¯çŠ¶æ€æ›´æ–°
    this.unifiedService.subscribe('chat', 'message_status', this.handleMessageStatus)

    // ç›‘å¬æœªè¯»è®¡æ•°æ›´æ–°
    this.unifiedService.subscribe('chat', 'unread_update', this.handleUnreadUpdate)

    // ç›‘å¬åœ¨çº¿çŠ¶æ€
    this.unifiedService.subscribe('presence', 'user_status', this.handleUserStatus)

    // ç›‘å¬é€šè¯é‚€è¯·
    this.unifiedService.subscribe('call', 'call_invite', this.handleCallInvite)
  }

  private handleNewMessage = (message: RealtimeMessage) => {
    const messageStore = useMessageStore()
    messageStore.receiveMessage(message.data)
  }

  private handleUnreadUpdate = (data: any) => {
    const messageStore = useMessageStore()
    messageStore.updateUnreadCount(data.chatId, data.count)
  }
}
```

## ğŸ“± UIç»„ä»¶æ¶æ„

### æ ¸å¿ƒç»„ä»¶è®¾è®¡
```typescript
// èŠå¤©åˆ—è¡¨ç»„ä»¶
interface ChatListComponent {
  props: {
    chats: Chat[]
    searchText: string
    showOnlineStatus: boolean
  }

  events: {
    chatClick: (chat: Chat) => void
    chatLongPress: (chat: Chat) => void
    deleteChat: (chatId: string) => void
    pinChat: (chatId: string) => void
    muteChat: (chatId: string) => void
  }

  computed: {
    filteredChats: Chat[]
    sortedChats: Chat[]
    totalUnread: number
  }
}

// èŠå¤©é¡µé¢ç»„ä»¶
interface ChatPageComponent {
  props: {
    chatId: string
  }

  data: {
    messages: Message[]
    inputText: string
    isRecording: boolean
    showEmojiPicker: boolean
    showMoreActions: boolean
  }

  methods: {
    sendTextMessage(): void
    sendVoiceMessage(): void
    sendImageMessage(): void
    sendLocationMessage(): void
    sendRedpacket(): void
    sendTransfer(): void
    startVoiceCall(): void
    startVideoCall(): void
  }
}

// æ¶ˆæ¯é¡¹ç»„ä»¶
interface MessageItemComponent {
  props: {
    message: Message
    showAvatar: boolean
    showTime: boolean
  }

  computed: {
    messageContent: string
    messageStatus: string
    isFromSelf: boolean
  }

  methods: {
    handleClick(): void
    handleLongPress(): void
    retryMessage(): void
    deleteMessage(): void
  }
}
```

### è¾“å…¥ç»„ä»¶è®¾è®¡
```typescript
// æ¶ˆæ¯è¾“å…¥ç»„ä»¶
interface MessageInputComponent {
  data: {
    inputText: string
    inputMode: 'text' | 'voice'
    isRecording: boolean
    recordingDuration: number
    showEmojiPicker: boolean
    showMoreActions: boolean
  }

  methods: {
    // æ–‡æœ¬è¾“å…¥
    handleTextInput(): void
    sendTextMessage(): void

    // è¯­éŸ³è¾“å…¥
    startVoiceRecording(): void
    stopVoiceRecording(): void
    cancelVoiceRecording(): void

    // æ›´å¤šåŠŸèƒ½
    selectImage(): void
    takePhoto(): void
    selectLocation(): void
    sendRedpacket(): void
    sendTransfer(): void
    sendContactCard(): void
  }
}

// æ›´å¤šåŠŸèƒ½é¢æ¿
interface MoreActionsPanel {
  actions: [
    { icon: 'camera', label: 'æ‹æ‘„', action: 'takePhoto' },
    { icon: 'image', label: 'å›¾ç‰‡', action: 'selectImage' },
    { icon: 'video', label: 'è§†é¢‘', action: 'selectVideo' },
    { icon: 'location', label: 'ä½ç½®', action: 'selectLocation' },
    { icon: 'redpacket', label: 'çº¢åŒ…', action: 'sendRedpacket' },
    { icon: 'transfer', label: 'è½¬è´¦', action: 'sendTransfer' },
    { icon: 'contact', label: 'åç‰‡', action: 'sendContactCard' },
    { icon: 'file', label: 'æ–‡ä»¶', action: 'selectFile' }
  ]
}
```

## ğŸ“‹ å®Œæ•´å¼€å‘è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„æ­å»º (4å°æ—¶)
#### 1.1 æ¸…ç†æ—§ä»£ç  (30åˆ†é’Ÿ)
- åˆ é™¤æ‰€æœ‰æ—§çš„Storeæ–‡ä»¶
- åˆ é™¤é‡å¤çš„ç»„ä»¶æ–‡ä»¶
- æ¸…ç†æ— ç”¨çš„APIæ–‡ä»¶

#### 1.2 åˆ›å»ºæ ¸å¿ƒStore (2å°æ—¶)
- åˆ›å»º `messageStore.ts` - ç»Ÿä¸€æ¶ˆæ¯ç®¡ç†
- å®ç° `MessageStorage` ç±» - IndexedDBå­˜å‚¨
- å®ç° `MediaFileManager` ç±» - åª’ä½“æ–‡ä»¶ç®¡ç†
- å®ç° `UnreadManager` ç±» - æœªè¯»è®¡æ•°ç®¡ç†
- é›†æˆç»Ÿä¸€å®æ—¶æœåŠ¡é€‚é…å™¨

#### 1.3 åŸºç¡€æ¶ˆæ¯åŠŸèƒ½ (1.5å°æ—¶)
- å®ç°æ¶ˆæ¯å‘é€ã€æ¥æ”¶ã€å»é‡é€»è¾‘
- å®ç°é»‘åå•æ£€æŸ¥æœºåˆ¶
- å®ç°ç¦»çº¿æ¶ˆæ¯å¤„ç†
- å®ç°æœªè¯»è®¡æ•°ç²¾ç¡®ç®¡ç†
- å®ç°æœ€åæ¶ˆæ¯å®æ—¶æ›´æ–°

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒUIç»„ä»¶ (3å°æ—¶)
#### 2.1 èŠå¤©åˆ—è¡¨ç»„ä»¶ (1å°æ—¶)
- é‡å†™ `ChatList.vue`
- å®ç°èŠå¤©é¡¹æ˜¾ç¤ºï¼ˆå¤´åƒã€å§“åã€æœ€åæ¶ˆæ¯ã€æ—¶é—´ã€æœªè¯»æ•°ï¼‰
- å®ç°èŠå¤©åˆ—è¡¨æ’åºï¼ˆç½®é¡¶ã€æ—¶é—´ï¼‰
- å®ç°æœç´¢åŠŸèƒ½
- å®ç°é•¿æŒ‰èœå•ï¼ˆç½®é¡¶ã€å…æ‰“æ‰°ã€åˆ é™¤ï¼‰

#### 2.2 èŠå¤©é¡µé¢ç»„ä»¶ (1.5å°æ—¶)
- é‡å†™ `ChatPage.vue`
- å®ç°æ¶ˆæ¯åˆ—è¡¨æ˜¾ç¤º
- å®ç°åˆ†é¡µåŠ è½½å†å²æ¶ˆæ¯
- å®ç°è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
- å®ç°æ¶ˆæ¯çŠ¶æ€æ˜¾ç¤º

#### 2.3 æ¶ˆæ¯è¾“å…¥ç»„ä»¶ (30åˆ†é’Ÿ)
- åˆ›å»º `MessageInput.vue`
- å®ç°æ–‡æœ¬è¾“å…¥æ¡†
- å®ç°å‘é€æŒ‰é’®
- å®ç°æ›´å¤šåŠŸèƒ½æŒ‰é’®

### ç¬¬ä¸‰é˜¶æ®µï¼šæ–‡æœ¬å’ŒåŸºç¡€åŠŸèƒ½ (2å°æ—¶)
#### 3.1 æ–‡æœ¬æ¶ˆæ¯æ¨¡å— (1å°æ—¶)
- å®ç°æ–‡æœ¬æ¶ˆæ¯å‘é€
- å®ç°è¡¨æƒ…åŒ…æ”¯æŒ
- å®ç°@æåŠåŠŸèƒ½
- å®ç°æ–‡æœ¬æ ¼å¼åŒ–

#### 3.2 æ¶ˆæ¯é¡¹ç»„ä»¶ (1å°æ—¶)
- åˆ›å»º `MessageItem.vue`
- å®ç°ä¸åŒç±»å‹æ¶ˆæ¯æ˜¾ç¤º
- å®ç°æ¶ˆæ¯çŠ¶æ€å›¾æ ‡
- å®ç°é•¿æŒ‰èœå•ï¼ˆå¤åˆ¶ã€åˆ é™¤ã€è½¬å‘ï¼‰

### ç¬¬å››é˜¶æ®µï¼šåª’ä½“æ¶ˆæ¯åŠŸèƒ½ (4å°æ—¶)
#### 4.1 è¯­éŸ³æ¶ˆæ¯æ¨¡å— (1.5å°æ—¶)
- å®ç°å½•éŸ³åŠŸèƒ½
- å®ç°è¯­éŸ³æ’­æ”¾
- å®ç°è¯­éŸ³è½¬æ–‡å­—
- å®ç°è¯­éŸ³è¾“å…¥ï¼ˆå®æ—¶è½¬æ–‡å­—ï¼‰
- åˆ›å»ºè¯­éŸ³æ¶ˆæ¯UIç»„ä»¶

#### 4.2 å›¾ç‰‡æ¶ˆæ¯æ¨¡å— (1.5å°æ—¶)
- å®ç°æ‹ç…§åŠŸèƒ½
- å®ç°å›¾ç‰‡é€‰æ‹©
- å®ç°å›¾ç‰‡å‹ç¼©
- å®ç°å›¾ç‰‡é¢„è§ˆ
- åˆ›å»ºå›¾ç‰‡æ¶ˆæ¯UIç»„ä»¶

#### 4.3 è§†é¢‘æ¶ˆæ¯æ¨¡å— (1å°æ—¶)
- å®ç°è§†é¢‘å½•åˆ¶
- å®ç°è§†é¢‘é€‰æ‹©
- å®ç°è§†é¢‘æ’­æ”¾
- å®ç°ç¼©ç•¥å›¾ç”Ÿæˆ
- åˆ›å»ºè§†é¢‘æ¶ˆæ¯UIç»„ä»¶

### ç¬¬äº”é˜¶æ®µï¼šä½ç½®å’Œé€šè¯åŠŸèƒ½ (3å°æ—¶)
#### 5.1 ä½ç½®æ¶ˆæ¯æ¨¡å— (1.5å°æ—¶)
- å®ç°ä½ç½®è·å–
- å®ç°ä½ç½®é€‰æ‹©
- å®ç°å®æ—¶ä½ç½®å…±äº«
- å®ç°åœ°å›¾æ˜¾ç¤º
- åˆ›å»ºä½ç½®æ¶ˆæ¯UIç»„ä»¶

#### 5.2 é€šè¯åŠŸèƒ½æ¨¡å— (1.5å°æ—¶)
- å®ç°è¯­éŸ³é€šè¯
- å®ç°è§†é¢‘é€šè¯
- å®ç°é€šè¯è®°å½•
- åˆ›å»ºé€šè¯UIç»„ä»¶
- é›†æˆé€šè¯çŠ¶æ€ç®¡ç†

### ç¬¬å…­é˜¶æ®µï¼šæ”¯ä»˜å’Œåç‰‡åŠŸèƒ½ (2.5å°æ—¶)
#### 6.1 çº¢åŒ…è½¬è´¦æ¨¡å— (1.5å°æ—¶)
- å®ç°çº¢åŒ…å‘é€
- å®ç°è½¬è´¦å‘é€
- å®ç°çº¢åŒ…é¢†å–
- å®ç°è½¬è´¦æ¥æ”¶
- åˆ›å»ºçº¢åŒ…è½¬è´¦UIç»„ä»¶

#### 6.2 åç‰‡æ¶ˆæ¯æ¨¡å— (1å°æ—¶)
- å®ç°åç‰‡å‘é€
- å®ç°åç‰‡æ˜¾ç¤º
- å®ç°æ·»åŠ è”ç³»äºº
- åˆ›å»ºåç‰‡UIç»„ä»¶

### ç¬¬ä¸ƒé˜¶æ®µï¼šæ•°æ®ç®¡ç†å’Œä¼˜åŒ– (2.5å°æ—¶)
#### 7.1 æ•°æ®æ¸…ç†åŠŸèƒ½ (1å°æ—¶)
- å®ç°èŠå¤©é¡¹åˆ é™¤æ—¶çš„æ•°æ®æ¸…ç†
- å®ç°ç”¨æˆ·æ³¨é”€æ—¶çš„æ•°æ®æ¸…ç†
- å®ç°è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ¶ˆæ¯
- å®ç°åª’ä½“æ–‡ä»¶æ¸…ç†

#### 7.2 æ€§èƒ½ä¼˜åŒ– (1å°æ—¶)
- ä¼˜åŒ–æ¶ˆæ¯åŠ è½½æ€§èƒ½
- ä¼˜åŒ–å›¾ç‰‡åŠ è½½å’Œç¼“å­˜
- ä¼˜åŒ–å†…å­˜ä½¿ç”¨
- ä¼˜åŒ–ç½‘ç»œè¯·æ±‚

#### 7.3 é”™è¯¯å¤„ç†å’Œé‡è¯• (30åˆ†é’Ÿ)
- å®Œå–„å‘é€å¤±è´¥é‡è¯•æœºåˆ¶
- å®Œå–„ç½‘ç»œé”™è¯¯å¤„ç†
- å®Œå–„ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

### ç¬¬å…«é˜¶æ®µï¼šå…¨é¢æµ‹è¯• (2å°æ—¶)
#### 8.1 åŠŸèƒ½æµ‹è¯• (1å°æ—¶)
- å®æ—¶æ¶ˆæ¯æ”¶å‘æµ‹è¯•
- ç¦»çº¿æ¶ˆæ¯åŒæ­¥æµ‹è¯•
- æœªè¯»è®¡æ•°å‡†ç¡®æ€§æµ‹è¯•
- å„ç§æ¶ˆæ¯ç±»å‹æµ‹è¯•

#### 8.2 é›†æˆæµ‹è¯• (1å°æ—¶)
- é»‘åå•åŠŸèƒ½æµ‹è¯•
- æ•°æ®æ¸…ç†åŠŸèƒ½æµ‹è¯•
- æ€§èƒ½å‹åŠ›æµ‹è¯•
- å…¼å®¹æ€§æµ‹è¯•

## ğŸ¯ é¢„æœŸæœ€ç»ˆæ•ˆæœ

### åŠŸèƒ½å®Œæ•´æ€§
- âœ… æ”¯æŒ10+ç§æ¶ˆæ¯ç±»å‹
- âœ… å®æ—¶æ¶ˆæ¯æ”¶å‘
- âœ… ç¦»çº¿æ¶ˆæ¯åŒæ­¥
- âœ… ç²¾ç¡®æœªè¯»è®¡æ•°
- âœ… æ™ºèƒ½æ•°æ®ç®¡ç†

### ç”¨æˆ·ä½“éªŒ
- âœ… æµç•…çš„äº¤äº’ä½“éªŒ
- âœ… ç›´è§‚çš„UIè®¾è®¡
- âœ… å¿«é€Ÿçš„å“åº”é€Ÿåº¦
- âœ… ç¨³å®šçš„åŠŸèƒ½è¡¨ç°

### æ•°æ®å®‰å…¨
- âœ… åˆ†ç±»å­˜å‚¨ç­–ç•¥
- âœ… ç”¨æˆ·éšç§ä¿æŠ¤
- âœ… æ•°æ®æ¸…ç†æœºåˆ¶
- âœ… å®‰å…¨çš„ä¼ è¾“åè®®

**æ€»å¼€å‘æ—¶é—´é¢„ä¼°ï¼š23å°æ—¶**
**å»ºè®®åˆ†3-4å¤©å®Œæˆï¼Œæ¯å¤©6-8å°æ—¶**
```
```
```
