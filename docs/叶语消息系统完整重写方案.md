# 叶语消息系统完整重写方案 v3.0

## 🎯 系统总体目标

- **功能完整**：支持文本、语音、图片、视频、位置、红包、转账等所有消息类型
- **实时准确**：在线离线状态下的消息、未读计数、最后消息实时更新
- **数据安全**：分类存储策略，用户隐私保护
- **用户体验**：流畅的交互，智能的功能集成

## 📊 完整数据结构设计

### 核心消息结构
```typescript
interface Message {
  id: string                    // 唯一ID：msg_时间戳_随机数
  chatId: string               // 聊天ID（对方用户ID）
  senderId: string             // 发送者ID
  receiverId: string           // 接收者ID
  content: string              // 消息内容
  type: MessageType            // 消息类型
  timestamp: number            // 发送时间戳
  status: MessageStatus        // 消息状态
  isSelf: boolean             // 是否自己发送
  retryCount?: number         // 重试次数
  isDeleted?: boolean         // 是否已删除
  
  // 媒体文件字段
  fileUrl?: string            // 服务器文件URL
  localPath?: string          // 本地文件路径
  fileSize?: number           // 文件大小
  duration?: number           // 语音/视频时长
  thumbnail?: string          // 缩略图
  fileName?: string           // 原始文件名
  mimeType?: string           // 文件类型
  
  // 位置信息字段
  latitude?: number           // 纬度
  longitude?: number          // 经度
  address?: string            // 地址描述
  locationName?: string       // 位置名称
  
  // 红包转账字段
  amount?: number             // 金额
  redpacketId?: string        // 红包ID
  transferId?: string         // 转账ID
  paymentStatus?: PaymentStatus
  remark?: string             // 备注
  
  // 名片字段
  contactCard?: {
    userId: string
    name: string
    avatar: string
    phone?: string
    yeyuId?: string
  }
  
  // 语音转文字字段
  transcription?: string      // 语音转文字结果
  transcriptionStatus?: 'pending' | 'completed' | 'failed'
  
  // 通话记录字段
  callDuration?: number       // 通话时长
  callType?: 'voice' | 'video'
  callStatus?: 'completed' | 'missed' | 'rejected' | 'failed'
}

enum MessageType {
  TEXT = 'text',
  IMAGE = 'image',
  VOICE = 'voice',
  VIDEO = 'video',
  FILE = 'file',
  LOCATION = 'location',
  REDPACKET = 'redpacket',
  TRANSFER = 'transfer',
  CONTACT_CARD = 'contact_card',
  VOICE_CALL = 'voice_call',
  VIDEO_CALL = 'video_call',
  SYSTEM = 'system'
}

enum MessageStatus {
  SENDING = 'sending',
  SENT = 'sent',
  DELIVERED = 'delivered',
  READ = 'read',
  FAILED = 'failed'
}

enum PaymentStatus {
  PENDING = 'pending',
  COMPLETED = 'completed',
  EXPIRED = 'expired',
  REFUNDED = 'refunded'
}
```

### 聊天列表结构
```typescript
interface Chat {
  id: string                  // 聊天ID（对方用户ID）
  userId: string              // 对方用户ID
  name: string                // 对方姓名
  avatar: string              // 对方头像
  lastMessage: string         // 最后一条消息内容
  lastMessageType: MessageType // 最后消息类型
  lastMessageTime: number     // 最后消息时间
  unreadCount: number         // 未读消息数
  isPinned: boolean          // 是否置顶
  isMuted: boolean           // 是否免打扰
  isDeleted: boolean         // 是否已删除
  createdAt: number          // 聊天创建时间
  updatedAt: number          // 最后更新时间
  
  // 在线状态
  isOnline: boolean          // 对方是否在线
  lastSeen?: number          // 最后在线时间
  
  // 草稿消息
  draftMessage?: string      // 草稿内容
  draftTime?: number         // 草稿时间
}
```

### 未读计数管理结构
```typescript
interface UnreadManager {
  totalUnread: number         // 总未读数
  chatUnreads: Map<string, number>  // 各聊天未读数
  mutedChats: Set<string>     // 免打扰聊天列表
  
  // 计算方法
  getTotalUnread(): number    // 获取总未读数（排除免打扰）
  getChatUnread(chatId: string): number  // 获取指定聊天未读数
  incrementUnread(chatId: string): void  // 增加未读数
  clearUnread(chatId: string): void      // 清除未读数
  markAsRead(chatId: string, messageId?: string): void  // 标记已读
}
```

## 🔄 核心业务流程

### 1. 消息发送完整流程
```
用户操作 → 消息类型判断 → 预处理（文件上传/位置获取等） → 创建消息对象
    ↓
立即显示(status: sending) → HTTP API发送 → 实时推送给接收者 → 更新发送状态
    ↓                          ↓                ↓
更新聊天列表最后消息        服务器存储        接收者实时收到/离线暂存
    ↓
发送失败则重试(最多3次) → 最终标记为failed
```

### 2. 消息接收完整流程
```
在线接收：
统一实时服务推送 → 黑名单检查 → 消息去重 → 添加到Store → 更新聊天列表
                      ↓              ↓           ↓            ↓
                  拒收则忽略      基于ID去重    保存本地     更新最后消息
                                                              ↓
                                                        更新未读计数
                                                              ↓
                                                        更新底部导航

离线接收：
服务器暂存消息 → 记录未读计数 → 用户上线 → 推送离线消息包 → 批量处理
                    ↓              ↓              ↓
                服务器端计数      检测连接        去重+显示+计数更新
```

### 3. 未读计数精确管理
```
消息接收时：
检查当前页面 → 是当前聊天页面：直接标记已读，不增加未读
                ↓
            非当前聊天：增加未读计数 → 更新聊天列表 → 更新底部导航红点

用户进入聊天页面：
加载消息 → 清除该聊天未读计数 → 发送已读回执给服务器 → 更新总未读计数

离线状态：
服务器接收消息 → 服务器端未读计数+1 → 用户上线 → 同步未读计数到客户端
```

### 4. 最后一条消息实时更新
```
在线状态：
发送/接收消息 → 立即更新聊天项lastMessage → 更新lastMessageTime → 重新排序聊天列表
                                              ↓
                                        保存到IndexedDB

离线状态：
服务器收到消息 → 更新服务器端聊天记录 → 用户上线 → 推送最新聊天状态
                                                    ↓
                                            更新本地聊天列表 → 重新排序
```

## 💾 存储系统详细设计

### IndexedDB存储结构
```typescript
// 数据库：YeYuMessages v2
const dbSchema = {
  // 消息表
  messages: {
    keyPath: 'id',
    indexes: [
      { name: 'chatId', keyPath: 'chatId' },
      { name: 'timestamp', keyPath: 'timestamp' },
      { name: 'type', keyPath: 'type' },
      { name: 'status', keyPath: 'status' }
    ]
  },
  
  // 聊天表
  chats: {
    keyPath: 'id',
    indexes: [
      { name: 'lastMessageTime', keyPath: 'lastMessageTime' },
      { name: 'unreadCount', keyPath: 'unreadCount' },
      { name: 'isPinned', keyPath: 'isPinned' }
    ]
  },
  
  // 未读计数表
  unreads: {
    keyPath: 'chatId',
    indexes: [
      { name: 'count', keyPath: 'count' },
      { name: 'updatedAt', keyPath: 'updatedAt' }
    ]
  },
  
  // 草稿表
  drafts: {
    keyPath: 'chatId',
    indexes: [
      { name: 'updatedAt', keyPath: 'updatedAt' }
    ]
  }
}
```

### 媒体文件存储策略
```typescript
// CacheStorage分类存储
const cacheStorageStrategy = {
  // 图片缓存
  'yeyu-images-v1': {
    pattern: /\.(jpg|jpeg|png|gif|webp)$/i,
    maxSize: '100MB',
    retention: '7天'
  },
  
  // 语音缓存
  'yeyu-voices-v1': {
    pattern: /\.(mp3|wav|m4a|aac)$/i,
    maxSize: '50MB',
    retention: '7天'
  },
  
  // 视频缓存
  'yeyu-videos-v1': {
    pattern: /\.(mp4|mov|avi)$/i,
    maxSize: '200MB',
    retention: '7天'
  },
  
  // 文件缓存
  'yeyu-files-v1': {
    pattern: /\.(pdf|doc|docx|xls|xlsx|ppt|pptx)$/i,
    maxSize: '100MB',
    retention: '7天'
  }
}
```

### 数据清理策略
```typescript
const dataCleanupPolicy = {
  // 自动清理规则
  autoCleanup: {
    textMessages: {
      client: '1年',
      server: '1年'
    },
    mediaMessages: {
      client: '7天',
      server: '1个月'
    },
    redpacketTransfer: {
      client: '永久',
      server: '永久（直到用户注销）'
    },
    callRecords: {
      client: '30天',
      server: '90天'
    },
    locationMessages: {
      client: '30天',
      server: '90天'
    }
  },
  
  // 用户操作清理
  userActions: {
    deleteChatItem: {
      action: 'clearLocalOnly',
      scope: ['messages', 'media', 'unreads', 'drafts']
    },
    accountDeletion: {
      action: 'clearAll',
      preserve: ['genealogy'],
      scope: ['messages', 'media', 'unreads', 'redpackets', 'transfers']
    }
  }
}
```

## 🎤 消息功能模块详细设计

### 1. 文本消息模块
```typescript
interface TextMessageModule {
  // 基础文本
  sendText(content: string, chatId: string): Promise<Message>

  // @提及功能
  sendMention(content: string, mentionUsers: string[], chatId: string): Promise<Message>

  // 表情包
  sendEmoji(emojiCode: string, chatId: string): Promise<Message>

  // 文本格式化
  formatText(content: string): string  // 支持粗体、斜体等
}
```

### 2. 语音消息模块
```typescript
interface VoiceMessageModule {
  // 录音功能
  startRecording(): Promise<void>
  stopRecording(): Promise<Blob>
  cancelRecording(): void

  // 语音发送
  sendVoice(audioBlob: Blob, duration: number, chatId: string): Promise<Message>

  // 语音转文字
  transcribeVoice(audioBlob: Blob): Promise<string>

  // 语音播放
  playVoice(message: Message): Promise<void>
  pauseVoice(): void

  // 语音输入（实时转文字）
  startVoiceInput(callback: (text: string) => void): Promise<void>
  stopVoiceInput(): void
}
```

### 3. 图片消息模块
```typescript
interface ImageMessageModule {
  // 拍照
  takePhoto(): Promise<Blob>

  // 选择图片
  selectImage(): Promise<Blob[]>

  // 图片编辑
  editImage(imageBlob: Blob): Promise<Blob>

  // 发送图片
  sendImage(imageBlob: Blob, chatId: string): Promise<Message>

  // 图片预览
  previewImage(message: Message): void

  // 图片压缩
  compressImage(imageBlob: Blob, quality: number): Promise<Blob>
}
```

### 4. 视频消息模块
```typescript
interface VideoMessageModule {
  // 录制视频
  startVideoRecording(): Promise<void>
  stopVideoRecording(): Promise<Blob>

  // 选择视频
  selectVideo(): Promise<Blob>

  // 发送视频
  sendVideo(videoBlob: Blob, thumbnail: Blob, duration: number, chatId: string): Promise<Message>

  // 视频播放
  playVideo(message: Message): void

  // 生成缩略图
  generateThumbnail(videoBlob: Blob): Promise<Blob>
}
```

### 5. 位置消息模块
```typescript
interface LocationMessageModule {
  // 获取当前位置
  getCurrentLocation(): Promise<LocationInfo>

  // 选择位置
  selectLocation(): Promise<LocationInfo>

  // 发送位置
  sendLocation(location: LocationInfo, chatId: string): Promise<Message>

  // 实时位置共享
  startLocationSharing(chatId: string, duration: number): Promise<void>
  stopLocationSharing(chatId: string): void

  // 位置显示
  showLocationOnMap(message: Message): void
}

interface LocationInfo {
  latitude: number
  longitude: number
  address: string
  name?: string
  accuracy?: number
}
```

### 6. 红包转账模块
```typescript
interface PaymentMessageModule {
  // 发送红包
  sendRedpacket(amount: number, count: number, remark: string, chatId: string): Promise<Message>

  // 发送转账
  sendTransfer(amount: number, remark: string, chatId: string): Promise<Message>

  // 领取红包
  claimRedpacket(redpacketId: string): Promise<ClaimResult>

  // 接收转账
  acceptTransfer(transferId: string): Promise<TransferResult>

  // 查看红包详情
  getRedpacketDetail(redpacketId: string): Promise<RedpacketDetail>

  // 查看转账详情
  getTransferDetail(transferId: string): Promise<TransferDetail>
}
```

### 7. 通话模块
```typescript
interface CallMessageModule {
  // 发起语音通话
  startVoiceCall(userId: string): Promise<CallSession>

  // 发起视频通话
  startVideoCall(userId: string): Promise<CallSession>

  // 接听通话
  answerCall(callId: string): Promise<void>

  // 拒绝通话
  rejectCall(callId: string): Promise<void>

  // 挂断通话
  endCall(callId: string): Promise<void>

  // 通话记录
  saveCallRecord(callSession: CallSession): Promise<Message>
}
```

### 8. 名片消息模块
```typescript
interface ContactCardModule {
  // 发送名片
  sendContactCard(contactInfo: ContactInfo, chatId: string): Promise<Message>

  // 添加联系人
  addContactFromCard(message: Message): Promise<void>

  // 查看名片详情
  viewContactCard(message: Message): void
}

interface ContactInfo {
  userId: string
  name: string
  avatar: string
  phone?: string
  yeyuId?: string
  company?: string
  title?: string
}
```

## 🔧 技术实现架构

### 统一消息Store
```typescript
class MessageStore {
  // 核心状态
  private messages = new Map<string, Message[]>()
  private chats = ref<Chat[]>([])
  private unreadManager = new UnreadManager()
  private currentChatId = ref<string>('')

  // 存储管理器
  private messageStorage = new MessageStorage()
  private mediaManager = new MediaFileManager()

  // 功能模块
  private textModule = new TextMessageModule()
  private voiceModule = new VoiceMessageModule()
  private imageModule = new ImageMessageModule()
  private videoModule = new VideoMessageModule()
  private locationModule = new LocationMessageModule()
  private paymentModule = new PaymentMessageModule()
  private callModule = new CallMessageModule()
  private contactModule = new ContactCardModule()

  // 核心方法
  async sendMessage(type: MessageType, data: any, chatId: string): Promise<Message>
  async receiveMessage(messageData: any): Promise<void>
  async loadMessages(chatId: string, page: number): Promise<Message[]>
  async markAsRead(chatId: string, messageId?: string): Promise<void>
  async deleteChat(chatId: string): Promise<void>
  async clearAllData(): Promise<void>
}
```

### 实时服务集成
```typescript
class RealtimeMessageHandler {
  private unifiedService = window.unifiedRealtimeService

  async initialize() {
    // 监听新消息
    this.unifiedService.subscribe('chat', 'new_message', this.handleNewMessage)

    // 监听消息状态更新
    this.unifiedService.subscribe('chat', 'message_status', this.handleMessageStatus)

    // 监听未读计数更新
    this.unifiedService.subscribe('chat', 'unread_update', this.handleUnreadUpdate)

    // 监听在线状态
    this.unifiedService.subscribe('presence', 'user_status', this.handleUserStatus)

    // 监听通话邀请
    this.unifiedService.subscribe('call', 'call_invite', this.handleCallInvite)
  }

  private handleNewMessage = (message: RealtimeMessage) => {
    const messageStore = useMessageStore()
    messageStore.receiveMessage(message.data)
  }

  private handleUnreadUpdate = (data: any) => {
    const messageStore = useMessageStore()
    messageStore.updateUnreadCount(data.chatId, data.count)
  }
}
```

## 📱 UI组件架构

### 核心组件设计
```typescript
// 聊天列表组件
interface ChatListComponent {
  props: {
    chats: Chat[]
    searchText: string
    showOnlineStatus: boolean
  }

  events: {
    chatClick: (chat: Chat) => void
    chatLongPress: (chat: Chat) => void
    deleteChat: (chatId: string) => void
    pinChat: (chatId: string) => void
    muteChat: (chatId: string) => void
  }

  computed: {
    filteredChats: Chat[]
    sortedChats: Chat[]
    totalUnread: number
  }
}

// 聊天页面组件
interface ChatPageComponent {
  props: {
    chatId: string
  }

  data: {
    messages: Message[]
    inputText: string
    isRecording: boolean
    showEmojiPicker: boolean
    showMoreActions: boolean
  }

  methods: {
    sendTextMessage(): void
    sendVoiceMessage(): void
    sendImageMessage(): void
    sendLocationMessage(): void
    sendRedpacket(): void
    sendTransfer(): void
    startVoiceCall(): void
    startVideoCall(): void
  }
}

// 消息项组件
interface MessageItemComponent {
  props: {
    message: Message
    showAvatar: boolean
    showTime: boolean
  }

  computed: {
    messageContent: string
    messageStatus: string
    isFromSelf: boolean
  }

  methods: {
    handleClick(): void
    handleLongPress(): void
    retryMessage(): void
    deleteMessage(): void
  }
}
```

### 输入组件设计
```typescript
// 消息输入组件
interface MessageInputComponent {
  data: {
    inputText: string
    inputMode: 'text' | 'voice'
    isRecording: boolean
    recordingDuration: number
    showEmojiPicker: boolean
    showMoreActions: boolean
  }

  methods: {
    // 文本输入
    handleTextInput(): void
    sendTextMessage(): void

    // 语音输入
    startVoiceRecording(): void
    stopVoiceRecording(): void
    cancelVoiceRecording(): void

    // 更多功能
    selectImage(): void
    takePhoto(): void
    selectLocation(): void
    sendRedpacket(): void
    sendTransfer(): void
    sendContactCard(): void
  }
}

// 更多功能面板
interface MoreActionsPanel {
  actions: [
    { icon: 'camera', label: '拍摄', action: 'takePhoto' },
    { icon: 'image', label: '图片', action: 'selectImage' },
    { icon: 'video', label: '视频', action: 'selectVideo' },
    { icon: 'location', label: '位置', action: 'selectLocation' },
    { icon: 'redpacket', label: '红包', action: 'sendRedpacket' },
    { icon: 'transfer', label: '转账', action: 'sendTransfer' },
    { icon: 'contact', label: '名片', action: 'sendContactCard' },
    { icon: 'file', label: '文件', action: 'selectFile' }
  ]
}
```

## 📋 完整开发计划

### 第一阶段：基础架构搭建 (4小时)
#### 1.1 清理旧代码 (30分钟)
- 删除所有旧的Store文件
- 删除重复的组件文件
- 清理无用的API文件

#### 1.2 创建核心Store (2小时)
- 创建 `messageStore.ts` - 统一消息管理
- 实现 `MessageStorage` 类 - IndexedDB存储
- 实现 `MediaFileManager` 类 - 媒体文件管理
- 实现 `UnreadManager` 类 - 未读计数管理
- 集成统一实时服务适配器

#### 1.3 基础消息功能 (1.5小时)
- 实现消息发送、接收、去重逻辑
- 实现黑名单检查机制
- 实现离线消息处理
- 实现未读计数精确管理
- 实现最后消息实时更新

### 第二阶段：核心UI组件 (3小时)
#### 2.1 聊天列表组件 (1小时)
- 重写 `ChatList.vue`
- 实现聊天项显示（头像、姓名、最后消息、时间、未读数）
- 实现聊天列表排序（置顶、时间）
- 实现搜索功能
- 实现长按菜单（置顶、免打扰、删除）

#### 2.2 聊天页面组件 (1.5小时)
- 重写 `ChatPage.vue`
- 实现消息列表显示
- 实现分页加载历史消息
- 实现自动滚动到底部
- 实现消息状态显示

#### 2.3 消息输入组件 (30分钟)
- 创建 `MessageInput.vue`
- 实现文本输入框
- 实现发送按钮
- 实现更多功能按钮

### 第三阶段：文本和基础功能 (2小时)
#### 3.1 文本消息模块 (1小时)
- 实现文本消息发送
- 实现表情包支持
- 实现@提及功能
- 实现文本格式化

#### 3.2 消息项组件 (1小时)
- 创建 `MessageItem.vue`
- 实现不同类型消息显示
- 实现消息状态图标
- 实现长按菜单（复制、删除、转发）

### 第四阶段：媒体消息功能 (4小时)
#### 4.1 语音消息模块 (1.5小时)
- 实现录音功能
- 实现语音播放
- 实现语音转文字
- 实现语音输入（实时转文字）
- 创建语音消息UI组件

#### 4.2 图片消息模块 (1.5小时)
- 实现拍照功能
- 实现图片选择
- 实现图片压缩
- 实现图片预览
- 创建图片消息UI组件

#### 4.3 视频消息模块 (1小时)
- 实现视频录制
- 实现视频选择
- 实现视频播放
- 实现缩略图生成
- 创建视频消息UI组件

### 第五阶段：位置和通话功能 (3小时)
#### 5.1 位置消息模块 (1.5小时)
- 实现位置获取
- 实现位置选择
- 实现实时位置共享
- 实现地图显示
- 创建位置消息UI组件

#### 5.2 通话功能模块 (1.5小时)
- 实现语音通话
- 实现视频通话
- 实现通话记录
- 创建通话UI组件
- 集成通话状态管理

### 第六阶段：支付和名片功能 (2.5小时)
#### 6.1 红包转账模块 (1.5小时)
- 实现红包发送
- 实现转账发送
- 实现红包领取
- 实现转账接收
- 创建红包转账UI组件

#### 6.2 名片消息模块 (1小时)
- 实现名片发送
- 实现名片显示
- 实现添加联系人
- 创建名片UI组件

### 第七阶段：数据管理和优化 (2.5小时)
#### 7.1 数据清理功能 (1小时)
- 实现聊天项删除时的数据清理
- 实现用户注销时的数据清理
- 实现自动清理过期消息
- 实现媒体文件清理

#### 7.2 性能优化 (1小时)
- 优化消息加载性能
- 优化图片加载和缓存
- 优化内存使用
- 优化网络请求

#### 7.3 错误处理和重试 (30分钟)
- 完善发送失败重试机制
- 完善网络错误处理
- 完善用户友好的错误提示

### 第八阶段：全面测试 (2小时)
#### 8.1 功能测试 (1小时)
- 实时消息收发测试
- 离线消息同步测试
- 未读计数准确性测试
- 各种消息类型测试

#### 8.2 集成测试 (1小时)
- 黑名单功能测试
- 数据清理功能测试
- 性能压力测试
- 兼容性测试

## 🎯 预期最终效果

### 功能完整性
- ✅ 支持10+种消息类型
- ✅ 实时消息收发
- ✅ 离线消息同步
- ✅ 精确未读计数
- ✅ 智能数据管理

### 用户体验
- ✅ 流畅的交互体验
- ✅ 直观的UI设计
- ✅ 快速的响应速度
- ✅ 稳定的功能表现

### 数据安全
- ✅ 分类存储策略
- ✅ 用户隐私保护
- ✅ 数据清理机制
- ✅ 安全的传输协议

**总开发时间预估：23小时**
**建议分3-4天完成，每天6-8小时**
```
```
```
