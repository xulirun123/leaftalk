# å¶è¯­æ¶ˆæ¯æ”¶å‘ç³»ç»Ÿé‡å†™æ–¹æ¡ˆ v2.0

## ğŸ¯ è®¾è®¡ç›®æ ‡

- **ç®€å•æ¸…æ™°**ï¼šå•ä¸€æ•°æ®æºï¼Œç»Ÿä¸€ç®¡ç†
- **å®æ—¶å‡†ç¡®**ï¼šæ¶ˆæ¯å®æ—¶æ”¶å‘ï¼Œæ— é‡å¤
- **é”™è¯¯å¤„ç†**ï¼šå‘é€å¤±è´¥é‡è¯•ï¼Œé»‘åå•æ‹’æ”¶
- **æ•°æ®å®‰å…¨**ï¼šåˆ†ç±»å­˜å‚¨ï¼Œç”¨æˆ·å¯æ§åˆ é™¤
- **éšç§ä¿æŠ¤**ï¼šæ³¨é”€æ¸…ç†ï¼Œæ¢è®¾å¤‡ä¸å¯æ¢å¤

## ğŸ“Š æ ¸å¿ƒæ•°æ®ç»“æ„

### æ¶ˆæ¯æ•°æ®ç»“æ„
```typescript
interface Message {
  id: string                    // å”¯ä¸€IDï¼šmsg_æ—¶é—´æˆ³_éšæœºæ•°
  chatId: string               // èŠå¤©IDï¼ˆå¯¹æ–¹ç”¨æˆ·IDï¼‰
  senderId: string             // å‘é€è€…ID
  receiverId: string           // æ¥æ”¶è€…ID
  content: string              // æ¶ˆæ¯å†…å®¹
  type: 'text' | 'image' | 'voice' | 'video' | 'file' | 'redpacket' | 'transfer'
  timestamp: number            // å‘é€æ—¶é—´æˆ³
  status: 'sending' | 'sent' | 'delivered' | 'read' | 'failed'
  isSelf: boolean             // æ˜¯å¦è‡ªå·±å‘é€
  retryCount?: number         // é‡è¯•æ¬¡æ•°
  isDeleted?: boolean         // æ˜¯å¦å·²åˆ é™¤ï¼ˆè½¯åˆ é™¤ï¼‰

  // åª’ä½“æ–‡ä»¶ç›¸å…³å­—æ®µ
  fileUrl?: string            // æœåŠ¡å™¨æ–‡ä»¶URL
  localPath?: string          // æœ¬åœ°æ–‡ä»¶è·¯å¾„
  fileSize?: number           // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  duration?: number           // è¯­éŸ³/è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰
  thumbnail?: string          // ç¼©ç•¥å›¾ï¼ˆå›¾ç‰‡/è§†é¢‘ï¼‰
  fileName?: string           // åŸå§‹æ–‡ä»¶å
  mimeType?: string           // æ–‡ä»¶MIMEç±»å‹

  // çº¢åŒ…/è½¬è´¦ç›¸å…³å­—æ®µ
  amount?: number             // é‡‘é¢
  redpacketId?: string        // çº¢åŒ…ID
  transferId?: string         // è½¬è´¦ID
  paymentStatus?: 'pending' | 'completed' | 'expired' | 'refunded'
}
```

### èŠå¤©æ•°æ®ç»“æ„
```typescript
interface Chat {
  id: string                  // èŠå¤©IDï¼ˆå¯¹æ–¹ç”¨æˆ·IDï¼‰
  userId: string              // å¯¹æ–¹ç”¨æˆ·ID
  name: string                // å¯¹æ–¹å§“å
  avatar: string              // å¯¹æ–¹å¤´åƒ
  lastMessage: string         // æœ€åä¸€æ¡æ¶ˆæ¯å†…å®¹
  lastMessageTime: number     // æœ€åæ¶ˆæ¯æ—¶é—´
  unreadCount: number         // æœªè¯»æ¶ˆæ¯æ•°
  isPinned: boolean          // æ˜¯å¦ç½®é¡¶
  isMuted: boolean           // æ˜¯å¦å…æ‰“æ‰°
  isDeleted: boolean         // æ˜¯å¦å·²åˆ é™¤èŠå¤©é¡¹
  createdAt: number          // èŠå¤©åˆ›å»ºæ—¶é—´
}
```

### æ•°æ®å­˜å‚¨ç­–ç•¥
```typescript
interface StoragePolicy {
  // å®¢æˆ·ç«¯å­˜å‚¨æ—¶é•¿
  clientStorage: {
    textMessages: number      // æ–‡æœ¬æ¶ˆæ¯ï¼š1å¹´
    mediaMessages: number     // åª’ä½“æ¶ˆæ¯ï¼š7å¤©
    redpacketTransfer: 'permanent'  // çº¢åŒ…è½¬è´¦ï¼šæ°¸ä¹…
  }

  // æœåŠ¡å™¨å­˜å‚¨æ—¶é•¿
  serverStorage: {
    messageRecords: number    // æ¶ˆæ¯è®°å½•ï¼š1å¹´
    mediaFiles: number        // åª’ä½“æ–‡ä»¶ï¼š1ä¸ªæœˆ
    redpacketTransfer: 'permanent'  // çº¢åŒ…è½¬è´¦ï¼šæ°¸ä¹…
  }

  // ç”¨æˆ·æ“ä½œå½±å“
  userActions: {
    deleteChatItem: 'clearLocal'     // åˆ é™¤èŠå¤©é¡¹ï¼šæ¸…ç†æœ¬åœ°
    accountDeletion: 'clearAll'      // æ³¨é”€è´¦å·ï¼šæ¸…ç†æ‰€æœ‰ï¼ˆä¿ç•™æ—è°±ï¼‰
    deviceChange: 'noRestore'        // æ¢è®¾å¤‡ï¼šä¸å¯æ¢å¤
  }
}
```

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### å•ä¸€Storeæ¶æ„
```
messageStore.ts (å”¯ä¸€æ¶ˆæ¯ç®¡ç†ä¸­å¿ƒ)
â”œâ”€â”€ æ¶ˆæ¯çŠ¶æ€ç®¡ç†
â”œâ”€â”€ èŠå¤©åˆ—è¡¨ç®¡ç†  
â”œâ”€â”€ æœªè¯»è®¡æ•°ç®¡ç†
â”œâ”€â”€ å®æ—¶æœåŠ¡é›†æˆ
â””â”€â”€ æœ¬åœ°å­˜å‚¨ç®¡ç†
```

### æ ¸å¿ƒç»„ä»¶
- `messageStore.ts` - å”¯ä¸€æ¶ˆæ¯ç®¡ç†Store
- `ChatList.vue` - èŠå¤©åˆ—è¡¨ç»„ä»¶
- `ChatPage.vue` - èŠå¤©é¡µé¢ç»„ä»¶
- `MessageInput.vue` - æ¶ˆæ¯è¾“å…¥ç»„ä»¶

## ğŸ”„ æ ¸å¿ƒç®—æ³•é€»è¾‘

### 1. æ¶ˆæ¯å‘é€æµç¨‹
```
ç”¨æˆ·è¾“å…¥æ¶ˆæ¯ â†’ ç«‹å³æ˜¾ç¤º(status: sending) â†’ HTTP APIå‘é€ â†’ å®æ—¶æ¨é€ç»™æ¥æ”¶è€…
                                                â†“                â†“
                                        æˆåŠŸ: sent          æ¥æ”¶è€…å®æ—¶æ”¶åˆ°
                                                â†“                â†“
                                        å¤±è´¥: failed        ç¦»çº¿åˆ™æœåŠ¡å™¨æš‚å­˜
                                                â†“
                                        è‡ªåŠ¨é‡è¯•(æœ€å¤š3æ¬¡)
```

### 2. å®æ—¶æ¶ˆæ¯æ¥æ”¶æµç¨‹
```
ç»Ÿä¸€å®æ—¶æœåŠ¡æ¨é€ â†’ æ£€æŸ¥é»‘åå• â†’ æ¶ˆæ¯å»é‡ â†’ æ·»åŠ åˆ°Store â†’ æ›´æ–°èŠå¤©åˆ—è¡¨
                      â†“              â†“           â†“            â†“
                  æ‹’æ”¶åˆ™å¿½ç•¥      åŸºäºIDå»é‡    ä¿å­˜æœ¬åœ°     æ›´æ–°æœªè¯»æ•°
```

### 3. ç¦»çº¿æ¶ˆæ¯å¤„ç†æµç¨‹
```
ç”¨æˆ·ç¦»çº¿æ—¶ â†’ æœåŠ¡å™¨æš‚å­˜æ¶ˆæ¯ â†’ ç”¨æˆ·ä¸Šçº¿ â†’ æœåŠ¡å™¨æ¨é€ç¦»çº¿æ¶ˆæ¯ â†’ å®¢æˆ·ç«¯æ¥æ”¶å¤„ç†
              â†“                    â†“              â†“              â†“
          æ¶ˆæ¯å·²ä¿å­˜            æ£€æµ‹åˆ°è¿æ¥        æ‰¹é‡æ¨é€        å»é‡åæ˜¾ç¤º
                                                                    â†“
                                                            æ›´æ–°æœªè¯»è®¡æ•°å’Œæœ€åæ¶ˆæ¯
```

### 4. æœªè¯»æ¶ˆæ¯è®¡æ•°æ›´æ–°æµç¨‹
```
åœ¨çº¿çŠ¶æ€ï¼š
æ¥æ”¶æ–°æ¶ˆæ¯ â†’ æ£€æŸ¥å½“å‰èŠå¤©é¡µé¢ â†’ æ˜¯å½“å‰èŠå¤©ï¼šä¸å¢åŠ æœªè¯» | éå½“å‰èŠå¤©ï¼š+1æœªè¯»
                                    â†“                        â†“
                              ç«‹å³æ ‡è®°å·²è¯»              æ›´æ–°èŠå¤©åˆ—è¡¨æœªè¯»æ•°
                                                            â†“
                                                    æ›´æ–°åº•éƒ¨å¯¼èˆªæ€»æœªè¯»æ•°

ç¦»çº¿çŠ¶æ€ï¼š
æœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯ â†’ æš‚å­˜æ¶ˆæ¯ â†’ è®°å½•æœªè¯»è®¡æ•° â†’ ç”¨æˆ·ä¸Šçº¿ â†’ æ¨é€ç¦»çº¿æ¶ˆæ¯ â†’ æ›´æ–°æœ¬åœ°æœªè¯»è®¡æ•°
```

### 5. æœ€åä¸€æ¡æ¶ˆæ¯æ›´æ–°æµç¨‹
```
åœ¨çº¿çŠ¶æ€ï¼š
å‘é€/æ¥æ”¶æ¶ˆæ¯ â†’ ç«‹å³æ›´æ–°èŠå¤©é¡¹æœ€åæ¶ˆæ¯ â†’ é‡æ–°æ’åºèŠå¤©åˆ—è¡¨ â†’ ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨

ç¦»çº¿çŠ¶æ€ï¼š
æœåŠ¡å™¨æ”¶åˆ°æ¶ˆæ¯ â†’ æ›´æ–°æœåŠ¡å™¨ç«¯èŠå¤©è®°å½• â†’ ç”¨æˆ·ä¸Šçº¿ â†’ æ¨é€æœ€æ–°èŠå¤©çŠ¶æ€ â†’ æ›´æ–°æœ¬åœ°èŠå¤©åˆ—è¡¨
```

### 4. æ¶ˆæ¯å»é‡ç®—æ³•
```typescript
// åŸºäºæ¶ˆæ¯IDå’Œæ—¶é—´æˆ³çš„åŒé‡å»é‡
const isDuplicate = (newMessage: Message) => {
  return messages.value.some(msg =>
    msg.id === newMessage.id ||
    (msg.senderId === newMessage.senderId &&
     msg.content === newMessage.content &&
     Math.abs(msg.timestamp - newMessage.timestamp) < 1000)
  )
}
```

### 5. é»‘åå•å¤„ç†ç®—æ³•
```typescript
// æ¥æ”¶æ¶ˆæ¯æ—¶æ£€æŸ¥é»‘åå•
const shouldRejectMessage = (senderId: string) => {
  const blacklistStore = useBlacklistStore()
  if (blacklistStore.isBlocked(senderId)) {
    console.log('ğŸš« æ‹’æ”¶é»‘åå•ç”¨æˆ·æ¶ˆæ¯:', senderId)
    return true
  }
  return false
}
```

### 6. èŠå¤©é¡¹åˆ é™¤å¤„ç†
```typescript
// åˆ é™¤èŠå¤©é¡¹æ—¶æ¸…ç†æœ¬åœ°æ•°æ®
const deleteChatItem = async (chatId: string) => {
  // 1. æ ‡è®°èŠå¤©ä¸ºå·²åˆ é™¤
  const chat = chats.value.find(c => c.id === chatId)
  if (chat) {
    chat.isDeleted = true
  }

  // 2. æ¸…ç†æœ¬åœ°æ¶ˆæ¯
  await messageStorage.clearChatMessages(chatId)

  // 3. æ¸…ç†åª’ä½“ç¼“å­˜
  await mediaFileManager.clearChatMedia(chatId)

  // 4. ä»èŠå¤©åˆ—è¡¨ç§»é™¤
  chats.value = chats.value.filter(c => c.id !== chatId)

  // 5. ä¸å½±å“æœåŠ¡å™¨æ•°æ®
  console.log('âœ… èŠå¤©é¡¹å·²åˆ é™¤ï¼Œæœ¬åœ°æ•°æ®å·²æ¸…ç†')
}
```

### 7. ç”¨æˆ·æ³¨é”€æ•°æ®æ¸…ç†
```typescript
// ç”¨æˆ·æ³¨é”€æ—¶çš„æ•°æ®æ¸…ç†ç­–ç•¥
const handleAccountDeletion = async (userId: string) => {
  // æœåŠ¡å™¨ç«¯æ¸…ç†ï¼ˆAPIè°ƒç”¨ï¼‰
  await api.delete('/user/chat-data', {
    data: {
      userId,
      clearChatMessages: true,      // æ¸…ç†èŠå¤©æ¶ˆæ¯
      clearRedpacketTransfer: true, // æ¸…ç†çº¢åŒ…è½¬è´¦è®°å½•
      preserveGenealogy: true       // ä¿ç•™æ—è°±æ•°æ®
    }
  })

  // å®¢æˆ·ç«¯æ¸…ç†
  await messageStorage.clearAllData()
  await mediaFileManager.clearAllCache()

  console.log('âœ… ç”¨æˆ·æ•°æ®å·²æ¸…ç†ï¼Œæ—è°±æ•°æ®å·²ä¿ç•™')
}
```

## ğŸ“± ç”¨æˆ·ç•Œé¢é€»è¾‘

### èŠå¤©åˆ—è¡¨æ˜¾ç¤ºé€»è¾‘
```typescript
// æ’åºï¼šç½®é¡¶ > æ—¶é—´å€’åº
const sortedChats = computed(() => {
  return chats.value.sort((a, b) => {
    if (a.isPinned && !b.isPinned) return -1
    if (!a.isPinned && b.isPinned) return 1
    return b.lastMessageTime - a.lastMessageTime
  })
})
```

### æœªè¯»è®¡æ•°æ˜¾ç¤ºé€»è¾‘
```typescript
// æ€»æœªè¯»æ•°ï¼šæ‰€æœ‰èŠå¤©æœªè¯»æ•°ä¹‹å’Œ
const totalUnreadCount = computed(() => {
  return chats.value.reduce((total, chat) => {
    return total + (chat.isMuted ? 0 : chat.unreadCount)
  }, 0)
})
```

### æ¶ˆæ¯çŠ¶æ€æ˜¾ç¤ºé€»è¾‘
```typescript
// æ¶ˆæ¯çŠ¶æ€å›¾æ ‡
const getStatusIcon = (status: string) => {
  switch (status) {
    case 'sending': return 'â³'
    case 'sent': return 'âœ“'
    case 'delivered': return 'âœ“âœ“'
    case 'read': return 'âœ“âœ“' // è“è‰²
    case 'failed': return 'âŒ'
  }
}
```

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. ç»Ÿä¸€å®æ—¶æœåŠ¡é›†æˆ
```typescript
// ä½¿ç”¨ç°æœ‰çš„ç»Ÿä¸€å®æ—¶æœåŠ¡ï¼Œä¸ä¿®æ”¹æœåŠ¡å™¨
const initRealtime = () => {
  const realtimeService = window.unifiedRealtimeService
  realtimeService.subscribe('chat', 'new_message', handleNewMessage)
}
```

### 2. æœ¬åœ°å­˜å‚¨ç­–ç•¥
```typescript
// ç§»åŠ¨ç«¯ä¼˜åŒ–å­˜å‚¨ï¼šIndexedDB + å†…å­˜ç¼“å­˜
class MessageStorage {
  private db: IDBDatabase | null = null
  private cache = new Map<string, Message[]>()

  async init() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('YeYuMessages', 1)

      request.onerror = () => reject(request.error)
      request.onsuccess = () => {
        this.db = request.result
        resolve(this.db)
      }

      request.onupgradeneeded = (event) => {
        const db = (event.target as IDBOpenDBRequest).result

        // åˆ›å»ºæ¶ˆæ¯è¡¨
        if (!db.objectStoreNames.contains('messages')) {
          const store = db.createObjectStore('messages', { keyPath: 'id' })
          store.createIndex('chatId', 'chatId', { unique: false })
          store.createIndex('timestamp', 'timestamp', { unique: false })
        }

        // åˆ›å»ºèŠå¤©è¡¨
        if (!db.objectStoreNames.contains('chats')) {
          db.createObjectStore('chats', { keyPath: 'id' })
        }
      }
    })
  }

  async saveMessages(chatId: string, messages: Message[]) {
    if (!this.db) await this.init()

    const transaction = this.db!.transaction(['messages'], 'readwrite')
    const store = transaction.objectStore('messages')

    // æ‰¹é‡ä¿å­˜æ¶ˆæ¯
    for (const message of messages) {
      store.put(message)
    }

    // æ›´æ–°å†…å­˜ç¼“å­˜
    this.cache.set(chatId, messages)

    return new Promise((resolve, reject) => {
      transaction.oncomplete = () => resolve(true)
      transaction.onerror = () => reject(transaction.error)
    })
  }

  async loadMessages(chatId: string, limit = 50): Promise<Message[]> {
    // å…ˆæ£€æŸ¥å†…å­˜ç¼“å­˜
    if (this.cache.has(chatId)) {
      return this.cache.get(chatId)!
    }

    if (!this.db) await this.init()

    return new Promise((resolve, reject) => {
      const transaction = this.db!.transaction(['messages'], 'readonly')
      const store = transaction.objectStore('messages')
      const index = store.index('chatId')
      const request = index.getAll(chatId)

      request.onsuccess = () => {
        const messages = request.result
          .sort((a, b) => a.timestamp - b.timestamp)
          .slice(-limit) // åªå–æœ€æ–°çš„æ¶ˆæ¯

        // æ›´æ–°ç¼“å­˜
        this.cache.set(chatId, messages)
        resolve(messages)
      }

      request.onerror = () => reject(request.error)
    })
  }

  // åˆ†ç±»æ¸…ç†æ—§æ¶ˆæ¯ï¼ˆä¿ç•™çº¢åŒ…è½¬è´¦è®°å½•ï¼‰
  async cleanOldMessages() {
    const sevenDaysAgo = Date.now() - 7 * 24 * 60 * 60 * 1000
    const oneYearAgo = Date.now() - 365 * 24 * 60 * 60 * 1000

    const transaction = this.db!.transaction(['messages'], 'readwrite')
    const store = transaction.objectStore('messages')
    const index = store.index('timestamp')

    // æ¸…ç†1å¹´å‰çš„æ–‡æœ¬æ¶ˆæ¯ï¼ˆä¿ç•™çº¢åŒ…è½¬è´¦ï¼‰
    const textRange = IDBKeyRange.upperBound(oneYearAgo)
    index.openCursor(textRange).onsuccess = (event) => {
      const cursor = (event.target as IDBRequest).result
      if (cursor) {
        const message = cursor.value
        if (message.type === 'text' && !['redpacket', 'transfer'].includes(message.type)) {
          cursor.delete()
        }
        cursor.continue()
      }
    }

    // æ¸…ç†7å¤©å‰çš„åª’ä½“æ¶ˆæ¯
    const mediaRange = IDBKeyRange.upperBound(sevenDaysAgo)
    index.openCursor(mediaRange).onsuccess = (event) => {
      const cursor = (event.target as IDBRequest).result
      if (cursor) {
        const message = cursor.value
        if (['image', 'voice', 'video', 'file'].includes(message.type)) {
          // åˆ é™¤æœ¬åœ°æ–‡ä»¶
          this.deleteLocalFile(message.localPath)
          // åˆ é™¤æ¶ˆæ¯è®°å½•
          cursor.delete()
        }
        cursor.continue()
      }
    }
  }

  // æ¸…ç†æŒ‡å®šèŠå¤©çš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆåˆ é™¤èŠå¤©é¡¹æ—¶è°ƒç”¨ï¼‰
  async clearChatMessages(chatId: string) {
    const transaction = this.db!.transaction(['messages'], 'readwrite')
    const store = transaction.objectStore('messages')
    const index = store.index('chatId')
    const request = index.openCursor(IDBKeyRange.only(chatId))

    request.onsuccess = (event) => {
      const cursor = (event.target as IDBRequest).result
      if (cursor) {
        const message = cursor.value
        // åˆ é™¤æœ¬åœ°åª’ä½“æ–‡ä»¶
        if (message.localPath) {
          this.deleteLocalFile(message.localPath)
        }
        // åˆ é™¤æ¶ˆæ¯è®°å½•
        cursor.delete()
        cursor.continue()
      }
    }

    // æ¸…ç†å†…å­˜ç¼“å­˜
    this.cache.delete(chatId)
  }

  // æ¸…ç†æ‰€æœ‰æ•°æ®ï¼ˆç”¨æˆ·æ³¨é”€æ—¶è°ƒç”¨ï¼‰
  async clearAllData() {
    if (!this.db) return

    const transaction = this.db.transaction(['messages', 'chats'], 'readwrite')

    // æ¸…ç†æ‰€æœ‰æ¶ˆæ¯
    const messageStore = transaction.objectStore('messages')
    await messageStore.clear()

    // æ¸…ç†æ‰€æœ‰èŠå¤©
    const chatStore = transaction.objectStore('chats')
    await chatStore.clear()

    // æ¸…ç†å†…å­˜ç¼“å­˜
    this.cache.clear()

    console.log('âœ… æ‰€æœ‰æœ¬åœ°èŠå¤©æ•°æ®å·²æ¸…ç†')
  }

  // åˆ é™¤æœ¬åœ°æ–‡ä»¶
  private async deleteLocalFile(filePath: string) {
    if (!filePath) return

    try {
      // å¦‚æœæ˜¯Webç¯å¢ƒï¼Œæ¸…ç†ç¼“å­˜
      if ('caches' in window) {
        const cache = await caches.open('yeyu-media')
        await cache.delete(filePath)
      }

      // å¦‚æœæ˜¯Cordova/Capacitorç¯å¢ƒï¼Œåˆ é™¤æ–‡ä»¶
      if (window.cordova?.file || window.Capacitor?.Plugins?.Filesystem) {
        // å…·ä½“å®ç°æ ¹æ®ä½¿ç”¨çš„æ¡†æ¶è€Œå®š
        console.log('åˆ é™¤æœ¬åœ°æ–‡ä»¶:', filePath)
      }
    } catch (error) {
      console.error('åˆ é™¤æœ¬åœ°æ–‡ä»¶å¤±è´¥:', error)
    }
  }
}

const messageStorage = new MessageStorage()

// åª’ä½“æ–‡ä»¶ç®¡ç†å™¨
class MediaFileManager {
  private cacheStorage: Cache | null = null

  async init() {
    if ('caches' in window) {
      this.cacheStorage = await caches.open('yeyu-media-v1')
    }
  }

  // ä¸‹è½½å¹¶ç¼“å­˜åª’ä½“æ–‡ä»¶
  async downloadAndCache(fileUrl: string, messageId: string, chatId: string): Promise<string> {
    try {
      const response = await fetch(fileUrl)
      const blob = await response.blob()

      // ç”Ÿæˆæœ¬åœ°è·¯å¾„ï¼ˆåŒ…å«chatIdä¾¿äºæ¸…ç†ï¼‰
      const localPath = `media/${chatId}/${messageId}_${Date.now()}`

      // ç¼“å­˜åˆ°CacheStorage
      if (this.cacheStorage) {
        await this.cacheStorage.put(localPath, new Response(blob))
      }

      return localPath
    } catch (error) {
      console.error('ä¸‹è½½åª’ä½“æ–‡ä»¶å¤±è´¥:', error)
      throw error
    }
  }

  // æ¸…ç†æŒ‡å®šèŠå¤©çš„åª’ä½“æ–‡ä»¶
  async clearChatMedia(chatId: string): Promise<void> {
    if (!this.cacheStorage) return

    try {
      const keys = await this.cacheStorage.keys()
      const chatMediaKeys = keys.filter(request =>
        request.url.includes(`media/${chatId}/`)
      )

      for (const key of chatMediaKeys) {
        await this.cacheStorage.delete(key)
      }

      console.log(`âœ… å·²æ¸…ç†èŠå¤© ${chatId} çš„åª’ä½“æ–‡ä»¶`)
    } catch (error) {
      console.error('æ¸…ç†èŠå¤©åª’ä½“æ–‡ä»¶å¤±è´¥:', error)
    }
  }

  // æ¸…ç†æ‰€æœ‰ç¼“å­˜ï¼ˆç”¨æˆ·æ³¨é”€æ—¶è°ƒç”¨ï¼‰
  async clearAllCache(): Promise<boolean> {
    try {
      if ('caches' in window) {
        return await caches.delete('yeyu-media-v1')
      }
      return true
    } catch (error) {
      console.error('æ¸…ç†æ‰€æœ‰ç¼“å­˜å¤±è´¥:', error)
      return false
    }
  }

  // è·å–æœ¬åœ°ç¼“å­˜æ–‡ä»¶
  async getLocalFile(localPath: string): Promise<Blob | null> {
    if (!this.cacheStorage || !localPath) return null

    try {
      const response = await this.cacheStorage.match(localPath)
      return response ? await response.blob() : null
    } catch (error) {
      console.error('è·å–æœ¬åœ°æ–‡ä»¶å¤±è´¥:', error)
      return null
    }
  }
}

const mediaFileManager = new MediaFileManager()
```

### 3. é”™è¯¯å¤„ç†ç­–ç•¥
```typescript
// ç»Ÿä¸€é”™è¯¯å¤„ç†
const handleError = (error: any, context: string) => {
  console.error(`[${context}] é”™è¯¯:`, error)
  // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
  showToast('æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•')
}
```

## ğŸ“‹ å®Œæ•´å¼€å‘æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ¸…ç†æ—§ä»£ç  (30åˆ†é’Ÿ)
- åˆ é™¤ `chatStore.ts`, `chat-new.ts`, `newChatStore.ts`, `chatStoreExample.ts`
- åˆ é™¤ `NewChatPage.vue`, `ChatList-new.vue` ç­‰é‡å¤ç»„ä»¶
- åˆ é™¤æ—§çš„ `chatApi.ts` æ–‡ä»¶
- æ¸…ç†æ— ç”¨çš„å¯¼å…¥å’Œå¼•ç”¨

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæ ¸å¿ƒå­˜å‚¨ç³»ç»Ÿ (120åˆ†é’Ÿ)
- åˆ›å»º `messageStore.ts` - ç»Ÿä¸€æ¶ˆæ¯ç®¡ç†
- å®ç° `MessageStorage` ç±» - IndexedDBå­˜å‚¨
- å®ç° `MediaFileManager` ç±» - åª’ä½“æ–‡ä»¶ç®¡ç†
- é›†æˆç»Ÿä¸€å®æ—¶æœåŠ¡é€‚é…å™¨
- å®ç°æ¶ˆæ¯å‘é€ã€æ¥æ”¶ã€å»é‡é€»è¾‘
- å®ç°é»‘åå•æ£€æŸ¥æœºåˆ¶
- å®ç°ç¦»çº¿æ¶ˆæ¯å¤„ç†
- å®ç°åˆ†ç±»æ•°æ®æ¸…ç†ç­–ç•¥

### ç¬¬ä¸‰æ­¥ï¼šé‡å†™æ ¸å¿ƒç»„ä»¶ (100åˆ†é’Ÿ)
- é‡å†™ `ChatList.vue` - èŠå¤©åˆ—è¡¨æ˜¾ç¤º
- é‡å†™ `ChatPage.vue` - èŠå¤©é¡µé¢
- åˆ›å»º `MessageItem.vue` - æ¶ˆæ¯é¡¹ç»„ä»¶
- åˆ›å»º `MessageInput.vue` - æ¶ˆæ¯è¾“å…¥ç»„ä»¶
- åˆ›å»ºçº¢åŒ…è½¬è´¦æ¶ˆæ¯ç»„ä»¶
- å®ç°èŠå¤©é¡¹åˆ é™¤åŠŸèƒ½

### ç¬¬å››æ­¥ï¼šå®Œå–„åŠŸèƒ½ç‰¹æ€§ (80åˆ†é’Ÿ)
- å®ç°æœªè¯»æ¶ˆæ¯è®¡æ•°ç³»ç»Ÿ
- å®ç°æ¶ˆæ¯çŠ¶æ€æ˜¾ç¤ºï¼ˆå‘é€ä¸­ã€å·²å‘é€ã€å¤±è´¥ï¼‰
- å®ç°å‘é€å¤±è´¥é‡è¯•æœºåˆ¶
- å®ç°åª’ä½“æ–‡ä»¶è‡ªåŠ¨ä¸‹è½½å’Œç¼“å­˜
- å®ç°èŠå¤©åˆ—è¡¨å®æ—¶æ’åº
- é›†æˆåº•éƒ¨å¯¼èˆªæ æœªè¯»è®¡æ•°æ˜¾ç¤º

### ç¬¬äº”æ­¥ï¼šæ•°æ®ç®¡ç†åŠŸèƒ½ (60åˆ†é’Ÿ)
- å®ç°èŠå¤©é¡¹åˆ é™¤æ—¶çš„æ•°æ®æ¸…ç†
- å®ç°ç”¨æˆ·æ³¨é”€æ—¶çš„æ•°æ®æ¸…ç†API
- å®ç°è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ¶ˆæ¯
- å®ç°çº¢åŒ…è½¬è´¦è®°å½•æ°¸ä¹…ä¿å­˜
- æµ‹è¯•æ¢è®¾å¤‡æ—¶æ•°æ®ä¸å¯æ¢å¤

### ç¬¬å…­æ­¥ï¼šå…¨é¢æµ‹è¯•ä¼˜åŒ– (50åˆ†é’Ÿ)
- å®æ—¶æ¶ˆæ¯æ”¶å‘æµ‹è¯•
- ç¦»çº¿æ¶ˆæ¯åŒæ­¥æµ‹è¯•
- é»‘åå•æ‹’æ”¶æµ‹è¯•
- æ¶ˆæ¯å»é‡æµ‹è¯•
- æ•°æ®æ¸…ç†åŠŸèƒ½æµ‹è¯•
- æ€§èƒ½ä¼˜åŒ–å’ŒBugä¿®å¤

## ğŸ¯ æœ€ç»ˆæ•ˆæœ

1. **æ¶ˆæ¯ä¸é‡å¤**ï¼šåŸºäºIDå’Œå†…å®¹çš„åŒé‡å»é‡æœºåˆ¶
2. **å®æ—¶æ€§å¼º**ï¼šå‘é€ç«‹å³æ˜¾ç¤ºï¼Œæ¥æ”¶å®æ—¶æ¨é€
3. **ç¦»çº¿æ¶ˆæ¯å‡†ç¡®**ï¼šæœåŠ¡å™¨æš‚å­˜ï¼Œä¸Šçº¿åæ‰¹é‡æ¨é€
4. **é»‘åå•ç”Ÿæ•ˆ**ï¼šæ¥æ”¶æ—¶æ£€æŸ¥ï¼Œç›´æ¥æ‹’æ”¶
5. **é”™è¯¯å¤„ç†å®Œå–„**ï¼šè‡ªåŠ¨é‡è¯•3æ¬¡ï¼ŒçŠ¶æ€æ¸…æ™°æ˜¾ç¤º
6. **æœªè¯»è®¡æ•°å‡†ç¡®**ï¼šå®æ—¶æ›´æ–°ï¼Œåº•éƒ¨å¯¼èˆªåŒæ­¥
7. **æ•°æ®åˆ†ç±»ç®¡ç†**ï¼š
   - æ–‡æœ¬æ¶ˆæ¯ï¼šå®¢æˆ·ç«¯1å¹´ï¼ŒæœåŠ¡å™¨1å¹´
   - åª’ä½“æ¶ˆæ¯ï¼šå®¢æˆ·ç«¯7å¤©ï¼ŒæœåŠ¡å™¨1ä¸ªæœˆ
   - çº¢åŒ…è½¬è´¦ï¼šæ°¸ä¹…ä¿å­˜
8. **ç”¨æˆ·æ•°æ®æ§åˆ¶**ï¼š
   - åˆ é™¤èŠå¤©é¡¹ï¼šæ¸…ç†æœ¬åœ°æ•°æ®
   - ç”¨æˆ·æ³¨é”€ï¼šæ¸…ç†æ‰€æœ‰æ•°æ®ï¼ˆä¿ç•™æ—è°±ï¼‰
   - æ¢è®¾å¤‡ï¼šä¸å¯æ¢å¤å†å²æ•°æ®
9. **ä»£ç æ¶æ„æ¸…æ™°**ï¼šå•ä¸€Storeï¼Œç»Ÿä¸€ç®¡ç†

## ğŸ”’ æ•°æ®å®‰å…¨ç­–ç•¥

### éšç§ä¿æŠ¤æœºåˆ¶
```typescript
// æ•°æ®æ¸…ç†ç­–ç•¥
const dataPrivacyPolicy = {
  // èŠå¤©é¡¹åˆ é™¤
  deleteChatItem: {
    clientAction: 'clearLocalData',     // æ¸…ç†æœ¬åœ°æ•°æ®
    serverAction: 'keepData',           // æœåŠ¡å™¨ä¿ç•™æ•°æ®
    recoverable: false                  // ä¸å¯æ¢å¤
  },

  // ç”¨æˆ·æ³¨é”€
  accountDeletion: {
    clientAction: 'clearAllData',       // æ¸…ç†æ‰€æœ‰æœ¬åœ°æ•°æ®
    serverAction: 'clearChatData',      // æ¸…ç†èŠå¤©ç›¸å…³æ•°æ®
    preserveData: ['genealogy'],        // ä¿ç•™æ—è°±æ•°æ®
    recoverable: false                  // ä¸å¯æ¢å¤
  },

  // æ¢è®¾å¤‡ç™»å½•
  deviceChange: {
    clientAction: 'noDataRestore',      // ä¸æ¢å¤å†å²æ•°æ®
    serverAction: 'keepData',           // æœåŠ¡å™¨ä¿ç•™æ•°æ®
    newDeviceAccess: 'newMessagesOnly'  // åªèƒ½æ¥æ”¶æ–°æ¶ˆæ¯
  }
}
```

### æœåŠ¡å™¨æ•°æ®ç®¡ç†
```typescript
// æœåŠ¡å™¨ç«¯æ•°æ®æ¸…ç†API
const serverDataManagement = {
  // è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®
  autoCleanup: {
    textMessages: '1å¹´ååˆ é™¤',
    mediaFiles: '1ä¸ªæœˆååˆ é™¤',
    redpacketTransfer: 'æ°¸ä¹…ä¿ç•™'
  },

  // ç”¨æˆ·æ³¨é”€æ¸…ç†
  userDeletionCleanup: {
    chatMessages: 'ç«‹å³åˆ é™¤',
    redpacketTransfer: 'ç«‹å³åˆ é™¤',
    mediaFiles: 'ç«‹å³åˆ é™¤',
    genealogyData: 'ä¿ç•™ä¸åˆ é™¤'
  }
}
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

- æ¶ˆæ¯å†…å®¹åŠ å¯†å­˜å‚¨
- é»‘åå•å®æ—¶ç”Ÿæ•ˆ
- æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
- é˜²æ­¢æ¶ˆæ¯é‡æ”¾æ”»å‡»

## ğŸ“± ç§»åŠ¨ç«¯å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”

### localStorageçš„é—®é¢˜
- **å®¹é‡é™åˆ¶**ï¼šé€šå¸¸åªæœ‰5-10MBï¼Œæ¶ˆæ¯å¤šäº†å®¹æ˜“è¶…é™
- **æ€§èƒ½é—®é¢˜**ï¼šåŒæ­¥æ“ä½œï¼Œå¤§é‡æ•°æ®ä¼šé˜»å¡UI
- **æ¸…ç†é£é™©**ï¼šç³»ç»Ÿæ¸…ç†ç¼“å­˜æ—¶å¯èƒ½ä¸¢å¤±æ•°æ®
- **éšç§æ¨¡å¼**ï¼šåœ¨éšç§/æ— ç—•æ¨¡å¼ä¸‹ä¸å¯ç”¨

### IndexedDBçš„ä¼˜åŠ¿
- **å¤§å®¹é‡**ï¼šé€šå¸¸å¯ç”¨ç©ºé—´ä¸ºç£ç›˜çš„50%ï¼Œè¶³å¤Ÿå­˜å‚¨å¤§é‡æ¶ˆæ¯
- **å¼‚æ­¥æ“ä½œ**ï¼šä¸ä¼šé˜»å¡UIçº¿ç¨‹
- **äº‹åŠ¡æ”¯æŒ**ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§
- **ç´¢å¼•æŸ¥è¯¢**ï¼šæ”¯æŒå¤æ‚æŸ¥è¯¢ï¼Œæ€§èƒ½æ›´å¥½
- **æŒä¹…åŒ–**ï¼šæ•°æ®æ›´å®‰å…¨ï¼Œä¸æ˜“ä¸¢å¤±

### æ··åˆå­˜å‚¨ç­–ç•¥
```typescript
// ä¸‰å±‚å­˜å‚¨æ¶æ„
class HybridStorage {
  // ç¬¬ä¸€å±‚ï¼šå†…å­˜ç¼“å­˜ï¼ˆæœ€å¿«ï¼Œå®¹é‡å°ï¼‰
  private memoryCache = new Map<string, Message[]>()

  // ç¬¬äºŒå±‚ï¼šIndexedDBï¼ˆå¿«é€Ÿï¼Œå®¹é‡å¤§ï¼‰
  private indexedDB: MessageStorage

  // ç¬¬ä¸‰å±‚ï¼šæœåŠ¡å™¨ï¼ˆæœ€æ…¢ï¼Œä½†æœ€å¯é ï¼‰
  private apiClient: ApiClient

  async getMessage(chatId: string): Promise<Message[]> {
    // 1. å…ˆæŸ¥å†…å­˜
    if (this.memoryCache.has(chatId)) {
      return this.memoryCache.get(chatId)!
    }

    // 2. å†æŸ¥IndexedDB
    const messages = await this.indexedDB.loadMessages(chatId)
    if (messages.length > 0) {
      this.memoryCache.set(chatId, messages)
      return messages
    }

    // 3. æœ€åæŸ¥æœåŠ¡å™¨
    const serverMessages = await this.apiClient.getMessages(chatId)
    await this.indexedDB.saveMessages(chatId, serverMessages)
    this.memoryCache.set(chatId, serverMessages)
    return serverMessages
  }
}
```

## ğŸ’¡ å…³é”®å®ç°ç»†èŠ‚

### æ¶ˆæ¯å‘é€å¤±è´¥å¤„ç†
```typescript
// å‘é€å¤±è´¥çš„å®Œæ•´å¤„ç†æµç¨‹
const sendMessage = async (content: string, type: string, receiverId: string) => {
  const message: Message = {
    id: generateMessageId(),
    chatId: receiverId,
    senderId: currentUserId,
    receiverId,
    content,
    type,
    timestamp: Date.now(),
    status: 'sending',
    isSelf: true,
    retryCount: 0
  }

  // 1. ç«‹å³æ˜¾ç¤ºæ¶ˆæ¯
  addMessageToUI(message)

  // 2. å‘é€åˆ°æœåŠ¡å™¨
  try {
    await sendToAPI(message)
    updateMessageStatus(message.id, 'sent')
  } catch (error) {
    // 3. å‘é€å¤±è´¥ï¼Œæ ‡è®°å¹¶é‡è¯•
    updateMessageStatus(message.id, 'failed')
    scheduleRetry(message)
  }
}
```

### é»‘åå•æ‹’æ”¶å¤„ç†
```typescript
// æ¥æ”¶æ¶ˆæ¯æ—¶çš„é»‘åå•æ£€æŸ¥
const handleIncomingMessage = (messageData: any) => {
  // 1. æ£€æŸ¥å‘é€è€…æ˜¯å¦åœ¨é»‘åå•
  if (isBlocked(messageData.senderId)) {
    console.log('ğŸš« æ‹’æ”¶é»‘åå•ç”¨æˆ·æ¶ˆæ¯:', messageData.senderId)
    return // ç›´æ¥å¿½ç•¥ï¼Œä¸åšä»»ä½•å¤„ç†
  }

  // 2. æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦é‡å¤
  if (isDuplicate(messageData)) {
    console.log('ğŸ”„ å¿½ç•¥é‡å¤æ¶ˆæ¯:', messageData.id)
    return
  }

  // 3. æ­£å¸¸å¤„ç†æ¶ˆæ¯
  const message = formatMessage(messageData)
  addMessage(message)
  updateChatList(message)
  incrementUnreadCount(message.chatId)
}
```

### ç¦»çº¿æ¶ˆæ¯åŒæ­¥
```typescript
// ç”¨æˆ·ä¸Šçº¿ååŒæ­¥ç¦»çº¿æ¶ˆæ¯
const syncOfflineMessages = async () => {
  try {
    const lastSyncTime = getLastSyncTime()
    const response = await api.get('/messages/offline', {
      params: { since: lastSyncTime }
    })

    response.data.messages.forEach(messageData => {
      handleIncomingMessage(messageData)
    })

    setLastSyncTime(Date.now())
  } catch (error) {
    console.error('ç¦»çº¿æ¶ˆæ¯åŒæ­¥å¤±è´¥:', error)
  }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. æ¶ˆæ¯åˆ†é¡µåŠ è½½
```typescript
// æŒ‰éœ€åŠ è½½å†å²æ¶ˆæ¯ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤š
const loadMoreMessages = async (chatId: string) => {
  const currentMessages = getChatMessages(chatId)
  const oldestMessage = currentMessages[0]

  const response = await api.get(`/chats/${chatId}/messages`, {
    params: {
      before: oldestMessage?.timestamp,
      limit: 20
    }
  })

  prependMessages(chatId, response.data.messages)
}
```

### 2. å†…å­˜ç®¡ç†
```typescript
// é™åˆ¶å†…å­˜ä¸­çš„æ¶ˆæ¯æ•°é‡ï¼Œè¶…å‡ºéƒ¨åˆ†å­˜å‚¨åˆ°localStorage
const MAX_MESSAGES_IN_MEMORY = 100

const addMessage = (message: Message) => {
  const chatMessages = getChatMessages(message.chatId)
  chatMessages.push(message)

  // å¦‚æœæ¶ˆæ¯è¿‡å¤šï¼Œå°†æ—§æ¶ˆæ¯ç§»åˆ°localStorage
  if (chatMessages.length > MAX_MESSAGES_IN_MEMORY) {
    const oldMessages = chatMessages.splice(0, 20)
    saveToLocalStorage(message.chatId, oldMessages)
  }
}
```

### 3. å®æ—¶è¿æ¥ä¼˜åŒ–
```typescript
// æ™ºèƒ½é‡è¿ï¼Œé¿å…é¢‘ç¹è¿æ¥
const smartReconnect = () => {
  let reconnectAttempts = 0
  const maxAttempts = 5

  const reconnect = () => {
    if (reconnectAttempts >= maxAttempts) {
      console.log('è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢é‡è¿')
      return
    }

    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000)
    setTimeout(() => {
      reconnectAttempts++
      initRealtime()
    }, delay)
  }

  return reconnect
}
```
