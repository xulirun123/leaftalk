# 叶语消息系统完整功能细节规格

## 🎯 系统总体架构

### 技术栈确定
- **前端框架**: Vue3 + Vite + Pinia
- **数据库**: MySQL 8.0 (服务器端主存储)
- **客户端缓存**: IndexedDB + localStorage + 内存缓存
- **实时通信**: 现有统一实时服务器 (unifiedRealtimeService)
- **文件存储**: 服务器文件存储 + 客户端缓存
- **现有组件**: 复用所有现有UI组件，不修改组件结构

### 存储策略
- **主存储**: MySQL服务器数据库 (永久可靠)
- **客户端缓存**: 三级缓存架构 (性能优化)
- **离线支持**: IndexedDB本地缓存 + 离线操作队列
- **数据同步**: 增量同步 + 冲突解决

## 📱 完整功能模块详细规格

### 1. 文本消息模块
```typescript
interface TextMessageFeatures {
  // 基础功能
  sendText: {
    input: string                    // 文本内容
    maxLength: 5000                  // 最大长度限制
    supportEmoji: true               // 支持表情符号
    supportMarkdown: false           // 不支持Markdown
    autoSave: true                   // 自动保存草稿
  }
  
  // 高级功能
  mention: {
    trigger: '@'                     // @触发符
    searchUsers: true                // 搜索用户
    highlightMention: true           // 高亮显示@用户
    notification: true               // @时发送通知
  }
  
  // 表情功能
  emoji: {
    picker: 'EmojiPicker.vue'        // 使用现有表情选择器
    recentEmoji: true                // 最近使用表情
    customEmoji: false               // 不支持自定义表情
    emojiShortcuts: true             // 支持表情快捷键
  }
  
  // 草稿功能
  draft: {
    autoSave: true                   // 自动保存
    saveInterval: 2000               // 2秒保存间隔
    maxDrafts: 100                   // 最多100个草稿
    crossDevice: false               // 不跨设备同步草稿
  }
  
  // 消息状态
  status: {
    sending: '发送中⏳'
    sent: '已发送✓'
    delivered: '已送达✓✓'
    read: '已读✓✓'
    failed: '发送失败❌'
  }
}
```

### 2. 语音消息模块
```typescript
interface VoiceMessageFeatures {
  // 录音功能 (使用现有VoiceRecorder.vue)
  recording: {
    component: 'VoiceRecorder.vue'   // 现有组件
    maxDuration: 60                  // 最大60秒
    minDuration: 1                   // 最小1秒
    format: 'mp3'                    // 音频格式
    quality: 'medium'                // 音质设置
    realTimeWaveform: true           // 实时波形显示
    pauseResume: true                // 支持暂停继续
  }
  
  // 播放功能
  playback: {
    autoPlay: false                  // 不自动播放
    showProgress: true               // 显示播放进度
    playbackSpeed: [0.5, 1.0, 1.5, 2.0]  // 播放速度选项
    backgroundPlay: true             // 后台播放
    proximityPause: true             // 接近传感器暂停
  }
  
  // 语音转文字
  speechToText: {
    enabled: true                    // 启用功能
    autoTranscribe: false            // 不自动转换
    manualTranscribe: true           // 手动转换
    language: 'zh-CN'                // 中文识别
    accuracy: 'high'                 // 高精度模式
    showTranscription: true          // 显示转换结果
  }
  
  // 语音输入
  voiceInput: {
    enabled: true                    // 启用功能
    realTimeTranscribe: true         // 实时转换
    autoSend: false                  // 不自动发送
    editBeforeSend: true             // 发送前可编辑
    fallbackToVoice: true            // 转换失败发送语音
  }
  
  // 语音增强
  enhancement: {
    noiseReduction: true             // 降噪处理
    volumeNormalization: true        // 音量标准化
    autoGainControl: true            // 自动增益控制
    echoCancellation: true           // 回声消除
  }
}
```

### 3. 图片消息模块
```typescript
interface ImageMessageFeatures {
  // 拍摄功能 (使用现有WeChatCamera.vue)
  camera: {
    component: 'WeChatCamera.vue'    // 现有相机组件
    frontBack: true                  // 前后摄像头切换
    flash: true                      // 闪光灯控制
    focusTap: true                   // 点击对焦
    gridLines: true                  // 网格线辅助
    aspectRatio: ['1:1', '4:3', '16:9']  // 宽高比选项
  }
  
  // 图片选择
  gallery: {
    multiSelect: true                // 多选支持
    maxSelect: 9                     // 最多9张
    albumView: true                  // 相册视图
    previewBeforeSend: true          // 发送前预览
    sortByDate: true                 // 按日期排序
  }
  
  // 图片编辑
  editing: {
    crop: true                       // 裁剪功能
    rotate: true                     // 旋转功能
    filters: ['原图', '黑白', '复古', '鲜艳', '柔和']  // 滤镜选项
    brightness: true                 // 亮度调节
    contrast: true                   // 对比度调节
    addText: true                    // 添加文字
    addStickers: false               // 不支持贴纸
  }
  
  // 图片处理
  processing: {
    autoCompress: true               // 自动压缩
    compressionQuality: 0.8          // 压缩质量80%
    maxWidth: 1920                   // 最大宽度
    maxHeight: 1920                  // 最大高度
    thumbnailSize: 200               // 缩略图尺寸
    progressiveJPEG: true            // 渐进式JPEG
  }
  
  // 图片预览
  preview: {
    fullScreen: true                 // 全屏预览
    pinchZoom: true                  // 捏合缩放
    swipeNavigation: true            // 滑动切换
    saveToAlbum: true                // 保存到相册
    shareToOther: true               // 分享到其他应用
    imageInfo: true                  // 显示图片信息
  }
}
```

### 4. 视频消息模块
```typescript
interface VideoMessageFeatures {
  // 视频录制 (扩展WeChatCamera.vue)
  recording: {
    component: 'WeChatCamera.vue'    // 扩展现有组件
    maxDuration: 60                  // 最大60秒
    minDuration: 3                   // 最小3秒
    resolution: ['720p', '1080p']    // 分辨率选项
    frameRate: 30                    // 帧率
    stabilization: true              // 防抖功能
    realTimePreview: true            // 实时预览
  }
  
  // 视频选择
  gallery: {
    videoOnly: true                  // 只显示视频
    durationLimit: 300               // 最大5分钟
    sizeLimit: 100                   // 最大100MB
    formatSupport: ['mp4', 'mov', 'avi']  // 支持格式
    previewThumbnail: true           // 预览缩略图
  }
  
  // 视频编辑
  editing: {
    trim: true                       // 裁剪时长
    crop: false                      // 不支持画面裁剪
    filters: ['原片', '电影', '复古', '鲜艳']  // 滤镜
    speedControl: [0.5, 1.0, 1.5, 2.0]  // 播放速度
    addMusic: false                  // 不支持添加音乐
    addText: false                   // 不支持添加文字
  }
  
  // 视频播放 (使用现有VideoPlayer.vue)
  playback: {
    component: 'VideoPlayer.vue'     // 现有播放器
    autoPlay: false                  // 不自动播放
    controls: true                   // 显示控制条
    fullScreen: true                 // 全屏播放
    pictureInPicture: true           // 画中画模式
    playbackSpeed: true              // 播放速度控制
    volumeControl: true              // 音量控制
  }
  
  // 视频处理
  processing: {
    autoCompress: true               // 自动压缩
    compressionLevel: 'medium'       // 压缩级别
    thumbnailGenerate: true          // 生成缩略图
    thumbnailTime: 1                 // 第1秒作为缩略图
    progressiveDownload: true        // 渐进式下载
  }
}
```

### 5. 位置消息模块
```typescript
interface LocationMessageFeatures {
  // 位置获取
  positioning: {
    gpsAccuracy: 'high'              // 高精度定位
    timeout: 10000                   // 10秒超时
    fallbackToNetwork: true          // 网络定位备用
    cacheLocation: true              // 缓存位置信息
    backgroundLocation: false        // 不后台定位
  }
  
  // 地图选择
  mapSelection: {
    mapProvider: 'baidu'             // 百度地图
    searchPOI: true                  // 搜索兴趣点
    nearbyPOI: true                  // 附近兴趣点
    customLocation: true             // 自定义位置
    locationHistory: true            // 位置历史
    favoriteLocations: true          // 收藏位置
  }
  
  // 实时位置共享
  liveLocation: {
    enabled: true                    // 启用功能
    duration: [15, 30, 60, 120]      // 共享时长(分钟)
    updateInterval: 10               // 10秒更新间隔
    accuracy: 'high'                 // 高精度模式
    batteryOptimized: true           // 电池优化
    privacyControl: true             // 隐私控制
  }
  
  // 位置显示
  display: {
    staticMap: true                  // 静态地图显示
    interactiveMap: true             // 可交互地图
    streetView: false                // 不支持街景
    navigation: true                 // 导航功能
    distanceCalculation: true        // 距离计算
    addressDisplay: true             // 地址显示
  }
  
  // 地址解析
  geocoding: {
    reverseGeocode: true             // 逆地理编码
    addressFormat: 'detailed'        // 详细地址格式
    languageSupport: ['zh-CN']       // 中文支持
    poiDetails: true                 // POI详细信息
    administrativeArea: true         // 行政区域信息
  }
}
```

### 6. 红包转账模块
```typescript
interface PaymentMessageFeatures {
  // 红包功能 (使用现有支付组件)
  redpacket: {
    components: '现有红包组件'         // 复用现有组件
    types: ['普通红包', '拼手气红包']   // 红包类型
    minAmount: 0.01                  // 最小金额
    maxAmount: 200                   // 最大金额
    maxCount: 100                    // 最大个数
    expiry: 24                       // 24小时过期
    blessing: true                   // 祝福语
    coverImage: true                 // 封面图片
  }
  
  // 转账功能
  transfer: {
    components: '现有转账组件'         // 复用现有组件
    minAmount: 0.01                  // 最小金额
    maxAmount: 5000                  // 最大金额
    instantTransfer: true            // 即时到账
    delayedTransfer: false           // 不支持延时转账
    remark: true                     // 转账备注
    confirmation: true               // 确认机制
  }
  
  // 支付验证
  security: {
    paymentPassword: true            // 支付密码
    biometric: true                  // 生物识别
    smsVerification: false           // 不需要短信验证
    amountLimit: true                // 金额限制
    dailyLimit: true                 // 每日限额
    riskControl: true                // 风险控制
  }
  
  // 交易记录
  records: {
    transactionHistory: true         // 交易历史
    detailView: true                 // 详情查看
    statusTracking: true             // 状态跟踪
    receiptGeneration: true          // 生成收据
    exportRecords: true              // 导出记录
    searchFilter: true               // 搜索筛选
  }
  
  // 钱包集成
  wallet: {
    balanceDisplay: true             // 余额显示
    recharge: true                   // 充值功能
    withdraw: true                   // 提现功能
    bankCardBinding: true            // 银行卡绑定
    paymentMethods: true             // 支付方式选择
    securitySettings: true           // 安全设置
  }
}
```

### 7. 通话模块
```typescript
interface CallMessageFeatures {
  // 音视频通话 (使用现有通话组件)
  calling: {
    components: '现有通话组件'         // 复用现有组件
    voiceCall: true                  // 语音通话
    videoCall: true                  // 视频通话
    groupCall: false                 // 不支持群组通话
    callWaiting: true                // 呼叫等待
    callForwarding: false            // 不支持呼叫转移
  }
  
  // 通话控制
  controls: {
    mute: true                       // 静音控制
    speaker: true                    // 扬声器切换
    cameraSwitch: true               // 摄像头切换
    videoToggle: true                // 视频开关
    hangup: true                     // 挂断通话
    reject: true                     // 拒接通话
  }
  
  // 通话质量
  quality: {
    adaptiveQuality: true            // 自适应质量
    networkDetection: true           // 网络检测
    qualityIndicator: true           // 质量指示器
    autoAdjustment: true             // 自动调整
    manualSettings: true             // 手动设置
    callStatistics: true             // 通话统计
  }
  
  // 通话记录
  records: {
    callHistory: true                // 通话历史
    missedCalls: true                // 未接来电
    callDuration: true               // 通话时长
    callTime: true                   // 通话时间
    redial: true                     // 重拨功能
    callDetails: true                // 通话详情
  }
  
  // 通话设置
  settings: {
    ringtone: true                   // 铃声设置
    vibration: true                  // 振动设置
    autoAnswer: false                // 不自动接听
    callBlocking: true               // 通话拦截
    doNotDisturb: true               // 免打扰模式
    callPermissions: true            // 通话权限
  }
}
```

### 8. 名片消息模块
```typescript
interface ContactCardFeatures {
  // 名片发送 (使用现有联系人组件)
  sending: {
    components: '现有联系人组件'       // 复用现有组件
    myCard: true                     // 发送我的名片
    friendCard: true                 // 发送好友名片
    multipleCards: true              // 批量发送名片
    cardPreview: true                // 名片预览
    customMessage: true              // 自定义消息
  }
  
  // 名片信息
  cardInfo: {
    avatar: true                     // 头像
    nickname: true                   // 昵称
    yeyuId: true                     // 叶语号
    phone: false                     // 不显示手机号
    email: false                     // 不显示邮箱
    company: false                   // 不显示公司
    title: false                     // 不显示职位
  }
  
  // 名片操作
  actions: {
    addContact: true                 // 添加联系人
    sendMessage: true                // 发送消息
    voiceCall: true                  // 语音通话
    videoCall: true                  // 视频通话
    viewProfile: true                // 查看资料
    blockUser: true                  // 拉黑用户
  }
  
  // 名片分享
  sharing: {
    qrCode: true                     // 二维码分享
    linkShare: false                 // 不支持链接分享
    qrScan: true                     // 扫描二维码
    nearbyShare: false               // 不支持附近分享
    socialShare: false               // 不支持社交分享
  }
  
  // 联系人集成
  integration: {
    contactSync: true                // 联系人同步
    friendRequest: true              // 好友请求
    remarkName: true                 // 备注名称
    contactGroups: false             // 不支持联系人分组
    favoriteContacts: true           // 收藏联系人
  }
}
```

### 9. 文件消息模块
```typescript
interface FileMessageFeatures {
  // 文件选择
  selection: {
    fileTypes: ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'zip', 'rar']
    maxFileSize: 100                 // 最大100MB
    multipleFiles: true              // 多文件选择
    cloudFiles: false                // 不支持云文件
    recentFiles: true                // 最近文件
  }
  
  // 文件上传
  upload: {
    progressIndicator: true          // 进度指示器
    pauseResume: true                // 暂停继续
    backgroundUpload: true           // 后台上传
    retryOnFailure: true             // 失败重试
    uploadQueue: true                // 上传队列
    compressionOption: true          // 压缩选项
  }
  
  // 文件预览
  preview: {
    documentPreview: true            // 文档预览
    imagePreview: true               // 图片预览
    videoPreview: true               // 视频预览
    audioPreview: true               // 音频预览
    textPreview: true                // 文本预览
    unsupportedFiles: '显示文件信息'   // 不支持的文件
  }
  
  // 文件下载
  download: {
    autoDownload: false              // 不自动下载
    manualDownload: true             // 手动下载
    downloadProgress: true           // 下载进度
    pauseResume: true                // 暂停继续
    backgroundDownload: true         // 后台下载
    downloadLocation: 'Downloads'    // 下载位置
  }
  
  // 文件管理
  management: {
    fileInfo: true                   // 文件信息
    fileSize: true                   // 文件大小
    uploadTime: true                 // 上传时间
    expiryTime: true                 // 过期时间
    deleteFile: true                 // 删除文件
    shareToOther: true               // 分享到其他应用
  }
}
```

### 10. 系统消息模块
```typescript
interface SystemMessageFeatures {
  // 系统通知
  notifications: {
    joinGroup: true                  // 加入群组
    leaveGroup: true                 // 离开群组
    groupNameChange: true            // 群名修改
    memberPromote: true              // 成员提升
    memberKick: true                 // 成员踢出
    friendRequest: true              // 好友请求
    friendAccept: true               // 好友接受
  }
  
  // 消息操作
  messageActions: {
    recall: true                     // 消息撤回
    forward: true                    // 消息转发
    reply: true                      // 消息回复
    quote: true                      // 消息引用
    copy: true                       // 复制消息
    delete: true                     // 删除消息
  }
  
  // 状态消息
  statusMessages: {
    typing: true                     // 正在输入
    online: true                     // 上线通知
    offline: false                   // 不显示离线
    lastSeen: true                   // 最后在线
    readReceipt: true                // 已读回执
    deliveryReceipt: true            // 送达回执
  }
  
  // 消息搜索
  search: {
    globalSearch: true               // 全局搜索
    chatSearch: true                 // 聊天内搜索
    messageType: true                // 按类型搜索
    dateRange: true                  // 日期范围
    senderFilter: true               // 发送者筛选
    contentSearch: true              // 内容搜索
  }
}
```

## 🔧 技术实现细节

### 数据存储详细规格
```typescript
interface StorageSpecification {
  // MySQL服务器存储
  mysql: {
    tables: {
      messages: '消息主表，支持所有消息类型'
      chats: '聊天基本信息表'
      chat_members: '聊天成员和个人设置表'
      users: '用户信息表'
      friendships: '好友关系表'
      media_files: '媒体文件索引表'
      payments: '红包转账记录表'
      call_records: '通话记录表'
    }
    retention: {
      messages: '1年自动清理'
      media_files: '1个月自动清理'
      payments: '永久保存(直到用户注销)'
      call_records: '90天自动清理'
    }
    performance: {
      indexing: '复合索引优化查询'
      partitioning: '按时间分区'
      caching: 'Redis查询缓存'
    }
  }

  // 客户端缓存存储
  clientCache: {
    memory: {
      currentChat: '当前聊天100条消息'
      chatList: '所有聊天列表'
      userProfiles: '常用用户资料'
      unreadCounts: '所有未读计数'
    }
    indexedDB: {
      messages: '每个聊天最多缓存200条'
      chats: '所有聊天信息'
      users: '用户信息缓存6小时'
      offlineQueue: '离线操作队列'
    }
    localStorage: {
      settings: '用户设置'
      tokens: '认证令牌'
      config: '应用配置'
    }
  }

  // 文件存储规格
  fileStorage: {
    server: {
      images: 'JPG/PNG，最大10MB'
      voices: 'MP3，最大10MB'
      videos: 'MP4，最大100MB'
      files: '各种格式，最大100MB'
      retention: '1个月自动清理'
    }
    client: {
      cacheSize: '最大2GB'
      retention: '7天自动清理'
      compression: '自动压缩优化'
    }
  }
}
```

### 实时通信集成规格
```typescript
interface RealtimeIntegration {
  // 使用现有统一实时服务
  service: 'window.unifiedRealtimeService'

  // 消息事件监听
  messageEvents: {
    'chat.new_message': '新消息接收'
    'chat.message_status': '消息状态更新'
    'chat.typing': '正在输入状态'
    'chat.read_receipt': '已读回执'
  }

  // 用户状态事件
  userEvents: {
    'presence.user_online': '用户上线'
    'presence.user_offline': '用户离线'
    'presence.user_status': '用户状态变更'
  }

  // 通话事件
  callEvents: {
    'call.invite': '通话邀请'
    'call.accept': '接受通话'
    'call.reject': '拒绝通话'
    'call.end': '结束通话'
  }

  // 系统事件
  systemEvents: {
    'system.friend_request': '好友请求'
    'system.group_invite': '群组邀请'
    'system.notification': '系统通知'
  }
}
```

### 现有组件集成规格
```typescript
interface ExistingComponentsIntegration {
  // 聊天相关组件
  chat: {
    'ChatList.vue': '聊天列表 - 修改数据源为新messageStore'
    'ChatPage.vue': '聊天页面 - 适配新的消息处理逻辑'
    'MobileTopBar.vue': '顶部导航 - 显示聊天标题和在线状态'
    'MobileTabBar.vue': '底部导航 - 显示未读计数红点'
  }

  // 媒体相关组件
  media: {
    'VoiceRecorder.vue': '语音录制 - 集成到消息输入'
    'WeChatCamera.vue': '相机组件 - 集成拍照录像功能'
    'VideoPlayer.vue': '视频播放 - 用于视频消息播放'
    'EmojiPicker.vue': '表情选择 - 集成到文本输入'
  }

  // 功能组件
  features: {
    '现有支付组件': '红包转账 - 集成到聊天功能'
    '现有通话组件': '音视频通话 - 集成通话发起和控制'
    '现有联系人组件': '联系人选择 - 用于名片发送'
    'UnifiedAvatar.vue': '统一头像 - 用于用户头像显示'
  }

  // 集成原则
  principles: {
    noModification: '不修改现有组件代码结构'
    dataSourceChange: '只修改组件的数据源'
    eventHandling: '适配组件的事件处理'
    propsAdaptation: '适配组件的props传递'
  }
}
```

### 数据清理和隐私规格
```typescript
interface DataPrivacySpecification {
  // 自动清理策略
  autoCleanup: {
    textMessages: {
      client: '1年后清理'
      server: '1年后清理'
    }
    mediaMessages: {
      client: '7天后清理'
      server: '1个月后清理'
    }
    redpacketTransfer: {
      client: '永久保存'
      server: '永久保存(直到用户注销)'
    }
    callRecords: {
      client: '30天后清理'
      server: '90天后清理'
    }
  }

  // 用户操作清理
  userActions: {
    deleteChatItem: {
      action: '删除聊天项'
      scope: '清理本地所有相关数据'
      server: '服务器数据保留'
      recovery: '不可恢复'
    }
    accountDeletion: {
      action: '用户注销'
      scope: '清理所有聊天相关数据'
      preserve: '保留族谱数据'
      server: '服务器端完全清理'
    }
    deviceChange: {
      action: '换设备登录'
      scope: '不恢复历史数据'
      newDevice: '只能接收新消息'
    }
  }

  // 黑名单机制
  blacklist: {
    messageBlocking: '自动拒收黑名单用户消息'
    callBlocking: '自动拒绝黑名单用户通话'
    statusHiding: '隐藏在线状态'
    notificationBlock: '屏蔽所有通知'
  }
}
```

### 性能优化规格
```typescript
interface PerformanceSpecification {
  // 响应时间目标
  responseTime: {
    messageSend: '< 100ms'
    chatListLoad: '< 200ms'
    imageLoad: '< 500ms'
    videoLoad: '< 1000ms'
    searchResults: '< 300ms'
  }

  // 内存使用目标
  memoryUsage: {
    maxMemory: '< 200MB'
    messageCache: '< 50MB'
    imageCache: '< 100MB'
    videoCache: '< 50MB'
  }

  // 网络优化
  networkOptimization: {
    batchRequests: '批量请求减少网络往返'
    compression: '数据压缩传输'
    caching: '智能缓存策略'
    preloading: '预加载常用数据'
  }

  // 数据库优化
  databaseOptimization: {
    indexing: '复合索引优化'
    partitioning: '表分区策略'
    queryOptimization: '查询语句优化'
    connectionPooling: '连接池管理'
  }
}
```

## 🎯 开发优先级和依赖关系

### 开发顺序
1. **基础架构** (MySQL + 缓存 + messageStore)
2. **文本消息** (验证整个流程)
3. **语音消息** (VoiceRecorder集成)
4. **图片消息** (WeChatCamera集成)
5. **视频消息** (VideoPlayer集成)
6. **位置消息** (地图API集成)
7. **红包转账** (现有支付组件集成)
8. **通话功能** (现有通话组件集成)
9. **名片文件** (联系人组件集成)
10. **系统消息** (高级功能)
11. **数据管理** (清理和安全)
12. **性能优化** (最终优化)

### 关键依赖
- MySQL数据库设计 → 所有功能的基础
- 客户端缓存系统 → 性能和离线支持
- 统一实时服务集成 → 实时消息收发
- 现有组件适配 → UI功能实现

这个详细的功能规格确保了开发过程中的每个细节都有明确的标准和要求。
```
